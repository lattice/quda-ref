<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>QUDA: quda/lib/dslash_quda.cu Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">QUDA&#160;<span id="projectnumber">v0.4.0</span></div>
   <div id="projectbrief">A library for QCD on GPUs</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">quda/lib/dslash_quda.cu</div>  </div>
</div>
<div class="contents">
<a href="dslash__quda_8cu.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="color__spinor__field_8h.html">color_spinor_field.h</a>&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;<a class="code" href="clover__field_8h.html">clover_field.h</a>&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="dslash__quda_8cu.html#a82e087efb87d848062f8371b462ff6a2">00009</a> <span class="preprocessor">#define BLOCK_DIM 64</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span>
<a name="l00011"></a>00011 <span class="comment">// these control the Wilson-type actions</span>
<a name="l00012"></a>00012 <span class="comment">//#define DIRECT_ACCESS_LINK</span>
<a name="l00013"></a>00013 <span class="comment">//#define DIRECT_ACCESS_WILSON_SPINOR</span>
<a name="l00014"></a>00014 <span class="comment">//#define DIRECT_ACCESS_WILSON_ACCUM</span>
<a name="l00015"></a>00015 <span class="comment">//#define DIRECT_ACCESS_WILSON_INTER</span>
<a name="l00016"></a>00016 <span class="comment">//#define DIRECT_ACCESS_WILSON_PACK_SPINOR</span>
<a name="l00017"></a>00017 <span class="comment">//#define DIRECT_ACCESS_CLOVER</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">//these are access control for staggered action</span>
<a name="l00020"></a>00020 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 200)</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="comment">//#define DIRECT_ACCESS_FAT_LINK</span>
<a name="l00022"></a>00022 <span class="comment">//#define DIRECT_ACCESS_LONG_LINK</span>
<a name="l00023"></a>00023 <span class="preprocessor">#define DIRECT_ACCESS_SPINOR</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="comment">//#define DIRECT_ACCESS_ACCUM</span>
<a name="l00025"></a>00025 <span class="comment">//#define DIRECT_ACCESS_INTER</span>
<a name="l00026"></a>00026 <span class="comment">//#define DIRECT_ACCESS_PACK</span>
<a name="l00027"></a>00027 <span class="preprocessor">#else</span>
<a name="l00028"></a><a class="code" href="dslash__quda_8cu.html#a9df773f7eb6e1606381c06afc4fa0a59">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define DIRECT_ACCESS_FAT_LINK</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="comment">//#define DIRECT_ACCESS_LONG_LINK</span>
<a name="l00030"></a>00030 <span class="comment">//#define DIRECT_ACCESS_SPINOR</span>
<a name="l00031"></a>00031 <span class="comment">//#define DIRECT_ACCESS_ACCUM</span>
<a name="l00032"></a>00032 <span class="comment">//#define DIRECT_ACCESS_INTER</span>
<a name="l00033"></a>00033 <span class="comment">//#define DIRECT_ACCESS_PACK</span>
<a name="l00034"></a>00034 <span class="preprocessor">#endif</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="quda__internal_8h.html">quda_internal.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="dslash__quda_8h.html">dslash_quda.h</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;<a class="code" href="inline__ptx_8h.html">inline_ptx.h</a>&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9">00041</a> <span class="keyword">enum</span> <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9">KernelType</a> {
<a name="l00042"></a><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">00042</a>   <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a> = 5,
<a name="l00043"></a><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a57540634dba1984b627a5f1cc927b2d6">00043</a>   <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a57540634dba1984b627a5f1cc927b2d6">EXTERIOR_KERNEL_X</a> = 0,
<a name="l00044"></a><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a63c80cb0a79a4de2242fa357bdefa6cc">00044</a>   <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a63c80cb0a79a4de2242fa357bdefa6cc">EXTERIOR_KERNEL_Y</a> = 1,
<a name="l00045"></a><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a84b6800b8dd2cf2c3ff5a32f6e410946">00045</a>   <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a84b6800b8dd2cf2c3ff5a32f6e410946">EXTERIOR_KERNEL_Z</a> = 2,
<a name="l00046"></a><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a018237f546d2e084c29e53c1c38f1234">00046</a>   <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a018237f546d2e084c29e53c1c38f1234">EXTERIOR_KERNEL_T</a> = 3
<a name="l00047"></a>00047 };
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="struct_dslash_param.html">00049</a> <span class="keyword">struct </span><a class="code" href="struct_dslash_param.html">DslashParam</a> {
<a name="l00050"></a><a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">00050</a>   <span class="keywordtype">int</span> <a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>; <span class="comment">// the desired number of active threads</span>
<a name="l00051"></a><a class="code" href="struct_dslash_param.html#a43877ae1ec8a85d45a2b74a2bad9c291">00051</a>   <span class="keywordtype">int</span> <a class="code" href="struct_dslash_param.html#a43877ae1ec8a85d45a2b74a2bad9c291">parity</a>;  <span class="comment">// Even-Odd or Odd-Even</span>
<a name="l00052"></a><a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">00052</a>   <span class="keywordtype">int</span> <a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[<a class="code" href="color__spinor__field_8h.html#aa69925e50554e0ea81dd89fdcb572bbc">QUDA_MAX_DIM</a>]; <span class="comment">// Whether to do comms or not</span>
<a name="l00053"></a><a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">00053</a>   <span class="keywordtype">int</span> <a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">ghostDim</a>[<a class="code" href="color__spinor__field_8h.html#aa69925e50554e0ea81dd89fdcb572bbc">QUDA_MAX_DIM</a>]; <span class="comment">// Whether a ghost zone has been allocated for a given dimension</span>
<a name="l00054"></a><a class="code" href="struct_dslash_param.html#a71a096e0b08481398ba30def5c0c6c6b">00054</a>   <span class="keywordtype">int</span> <a class="code" href="struct_dslash_param.html#a71a096e0b08481398ba30def5c0c6c6b">ghostOffset</a>[<a class="code" href="color__spinor__field_8h.html#aa69925e50554e0ea81dd89fdcb572bbc">QUDA_MAX_DIM</a>];
<a name="l00055"></a><a class="code" href="struct_dslash_param.html#ac8762c9f3aa29fd85632efc13a3aff6f">00055</a>   <span class="keywordtype">int</span> <a class="code" href="struct_dslash_param.html#ac8762c9f3aa29fd85632efc13a3aff6f">ghostNormOffset</a>[<a class="code" href="color__spinor__field_8h.html#aa69925e50554e0ea81dd89fdcb572bbc">QUDA_MAX_DIM</a>];
<a name="l00056"></a><a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">00056</a>   <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9">KernelType</a> <a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a>; <span class="comment">//is it INTERIOR_KERNEL, EXTERIOR_KERNEL_X/Y/Z/T</span>
<a name="l00057"></a>00057 };
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">// determines whether the temporal ghost zones are packed with a gather kernel,</span>
<a name="l00060"></a>00060 <span class="comment">// as opposed to multiple calls to cudaMemcpy()</span>
<a name="l00061"></a><a class="code" href="wilson__dslash__test_8cpp.html#a483a625e972daef15aea1c8ffffcc9ee">00061</a> <span class="keywordtype">bool</span> <a class="code" href="cuda__color__spinor__field_8cpp.html#a483a625e972daef15aea1c8ffffcc9ee">kernelPackT</a> = <span class="keyword">false</span>;
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="dslash__quda_8cu.html#a1779b4d712901ca4fec765531f2d0b1d">00063</a> <a class="code" href="struct_dslash_param.html">DslashParam</a> <a class="code" href="dslash__quda_8cu.html#a1779b4d712901ca4fec765531f2d0b1d">dslashParam</a>;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">// these are set in initDslashConst</span>
<a name="l00066"></a><a class="code" href="dslash__quda_8cu.html#ad92dc3c43b8b2fa108abe3e55c3f4496">00066</a> <span class="keywordtype">int</span> <a class="code" href="dslash__quda_8cu.html#ad92dc3c43b8b2fa108abe3e55c3f4496">Vspatial</a>;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">static</span> cudaEvent_t packEnd[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00069"></a>00069 <span class="keyword">static</span> cudaEvent_t gatherStart[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00070"></a>00070 <span class="keyword">static</span> cudaEvent_t gatherEnd[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00071"></a>00071 <span class="keyword">static</span> cudaEvent_t scatterStart[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00072"></a>00072 <span class="keyword">static</span> cudaEvent_t scatterEnd[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="keyword">static</span> <span class="keyword">struct </span>timeval dslashStart_h;
<a name="l00075"></a>00075 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>timeval commsStart[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00077"></a>00077 <span class="keyword">static</span> <span class="keyword">struct </span>timeval commsEnd[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00078"></a>00078 <span class="preprocessor">#endif</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a>00080 <span class="comment">// these events are only used for profiling</span>
<a name="l00081"></a>00081 <span class="preprocessor">#ifdef DSLASH_PROFILING</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#define DSLASH_TIME_PROFILE() dslashTimeProfile()</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a>00084 <span class="keyword">static</span> cudaEvent_t dslashStart;
<a name="l00085"></a>00085 <span class="keyword">static</span> cudaEvent_t dslashEnd;
<a name="l00086"></a>00086 <span class="keyword">static</span> cudaEvent_t packStart[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00087"></a>00087 <span class="keyword">static</span> cudaEvent_t kernelStart[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00088"></a>00088 <span class="keyword">static</span> cudaEvent_t kernelEnd[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">// dimension 2 because we want absolute and relative</span>
<a name="l00091"></a>00091 <span class="keywordtype">float</span> packTime[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>][2];
<a name="l00092"></a>00092 <span class="keywordtype">float</span> gatherTime[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>][2];
<a name="l00093"></a>00093 <span class="keywordtype">float</span> commsTime[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>][2];
<a name="l00094"></a>00094 <span class="keywordtype">float</span> scatterTime[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>][2];
<a name="l00095"></a>00095 <span class="keywordtype">float</span> kernelTime[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>][2];
<a name="l00096"></a>00096 <span class="keywordtype">float</span> dslashTime;
<a name="l00097"></a>00097 <span class="preprocessor">#define CUDA_EVENT_RECORD(a,b) cudaEventRecord(a,b)</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00099"></a><a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define CUDA_EVENT_RECORD(a,b)</span>
<a name="l00100"></a><a class="code" href="dslash__quda_8cu.html#aca98c17a71baa5a33c4f4bc5d341d596">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define DSLASH_TIME_PROFILE()</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span>
<a name="l00103"></a><a class="code" href="dslash__quda_8cu.html#a3095a1f619e2c473021f7f04432dcc20">00103</a> <a class="code" href="class_face_buffer.html">FaceBuffer</a> *<a class="code" href="dslash__quda_8cu.html#a3095a1f619e2c473021f7f04432dcc20">face</a>;
<a name="l00104"></a><a class="code" href="dslash__quda_8cu.html#a57890cc94072086d5eee1e8aa4dcb464">00104</a> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="dslash__quda_8cu.html#a57890cc94072086d5eee1e8aa4dcb464">inSpinor</a>;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">// For tuneLaunch() to uniquely identify a suitable set of launch parameters, we need copies of a few of</span>
<a name="l00107"></a>00107 <span class="comment">// the constants set by initDslashConstants().</span>
<a name="l00108"></a>00108 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00109"></a><a class="code" href="dslash__quda_8cu.html#ab497c9cc64d8241f54bee95e694ff756">00109</a>   <span class="keywordtype">int</span> <a class="code" href="blas__quda_8cu.html#ab785f167db51e5445112e14e0b8ef6ae">x</a>[4];
<a name="l00110"></a><a class="code" href="dslash__quda_8cu.html#a96202c3467aa608f6feee09ded0065a5">00110</a>   <span class="keywordtype">int</span> <a class="code" href="dslash__constants_8h.html#a55712790b263340f40d031cdef2b4c56">Ls</a>;
<a name="l00111"></a>00111   <span class="comment">// In the future, we may also want to add gauge_fixed, sp_stride, ga_stride, cl_stride, etc.</span>
<a name="l00112"></a>00112 } dslashConstants;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="comment">// dslashTuning = QUDA_TUNE_YES enables autotuning when the dslash is</span>
<a name="l00115"></a>00115 <span class="comment">// first launched</span>
<a name="l00116"></a>00116 <span class="keyword">static</span> <a class="code" href="enum__quda_8h.html#ae1992c8a469e4979a23f6177d8058a21">QudaTune</a> dslashTuning = <a class="code" href="enum__quda_8h.html#ab692679068e8ef209853c1ee7e9f1f89a84cd8a855debe802a41b6782d056cc51">QUDA_TUNE_NO</a>;
<a name="l00117"></a>00117 <span class="keyword">static</span> <a class="code" href="enum__quda_8h.html#a548da41d47a2128b7462a3595297ac76">QudaVerbosity</a> verbosity = <a class="code" href="enum__quda_8h.html#a49355eae66447edf8f077f2dc5e214c6a04424f5d2f1159bf7192a800039dc031">QUDA_SILENT</a>;
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="dslash__quda_8cu.html#adf6536dd6357c4d3a441cd35124689b4">00119</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#adf6536dd6357c4d3a441cd35124689b4">setDslashTuning</a>(<a class="code" href="enum__quda_8h.html#ae1992c8a469e4979a23f6177d8058a21">QudaTune</a> <a class="code" href="staggered__dslash__test_8cpp.html#a10c8ecd1e18b84f28bcd500d0476995d">tune</a>, <a class="code" href="enum__quda_8h.html#a548da41d47a2128b7462a3595297ac76">QudaVerbosity</a> verbose)
<a name="l00120"></a>00120 {
<a name="l00121"></a>00121   dslashTuning = <a class="code" href="staggered__dslash__test_8cpp.html#a10c8ecd1e18b84f28bcd500d0476995d">tune</a>;
<a name="l00122"></a>00122   verbosity = verbose;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="preprocessor">#include &lt;<a class="code" href="dslash__textures_8h.html">dslash_textures.h</a>&gt;</span>
<a name="l00126"></a>00126 <span class="preprocessor">#include &lt;<a class="code" href="dslash__constants_8h.html">dslash_constants.h</a>&gt;</span>
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="keyword">static</span> <span class="keyword">inline</span> __device__ <span class="keywordtype">float</span> short2float(<span class="keywordtype">short</span> a) {
<a name="l00129"></a>00129   <span class="keywordflow">return</span> (<span class="keywordtype">float</span>)a/<a class="code" href="quda__internal_8h.html#a3742efaf988af88c727a30ca9d8d993f">MAX_SHORT</a>;
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="keyword">static</span> <span class="keyword">inline</span> __device__ <span class="keywordtype">short</span> float2short(<span class="keywordtype">float</span> c, <span class="keywordtype">float</span> a) {
<a name="l00133"></a>00133   <span class="keywordflow">return</span> (<span class="keywordtype">short</span>)(a*c*<a class="code" href="quda__internal_8h.html#a3742efaf988af88c727a30ca9d8d993f">MAX_SHORT</a>);
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keyword">inline</span> __device__ short2 float22short2(<span class="keywordtype">float</span> c, float2 a) {
<a name="l00137"></a>00137   <span class="keywordflow">return</span> make_short2((<span class="keywordtype">short</span>)(a.x*c*<a class="code" href="quda__internal_8h.html#a3742efaf988af88c727a30ca9d8d993f">MAX_SHORT</a>), (<span class="keywordtype">short</span>)(a.y*c*MAX_SHORT));
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="preprocessor">#if defined(DIRECT_ACCESS_LINK) || defined(DIRECT_ACCESS_WILSON_SPINOR) || \</span>
<a name="l00141"></a>00141 <span class="preprocessor">  defined(DIRECT_ACCESS_WILSON_ACCUM) || defined(DIRECT_ACCESS_WILSON_PACK_SPINOR) || \</span>
<a name="l00142"></a>00142 <span class="preprocessor">  defined(DIRECT_ACCESS_WILSON_INTER) || defined(DIRECT_ACCESS_WILSON_PACK_SPINOR)</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>
<a name="l00144"></a>00144 <span class="keyword">static</span> <span class="keyword">inline</span> __device__ short4 float42short4(<span class="keywordtype">float</span> c, float4 a) {
<a name="l00145"></a>00145   <span class="keywordflow">return</span> make_short4(float2short(c, a.x), float2short(c, a.y), float2short(c, a.z), float2short(c, a.w));
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="keyword">static</span> <span class="keyword">inline</span> __device__ float4 short42float4(short4 a) {
<a name="l00149"></a>00149   <span class="keywordflow">return</span> make_float4(short2float(a.x), short2float(a.y), short2float(a.z), short2float(a.w));
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="keyword">static</span> <span class="keyword">inline</span> __device__ float2 short22float2(short2 a) {
<a name="l00153"></a>00153   <span class="keywordflow">return</span> make_float2(short2float(a.x), short2float(a.y));
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 <span class="preprocessor">#endif // DIRECT_ACCESS inclusions</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>
<a name="l00157"></a>00157 <span class="comment">// Enable shared memory dslash for Fermi architecture</span>
<a name="l00158"></a>00158 <span class="comment">//#define SHARED_WILSON_DSLASH</span>
<a name="l00159"></a>00159 <span class="comment">//#define SHARED_8_BYTE_WORD_SIZE // 8-byte shared memory access</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="preprocessor">#include &lt;<a class="code" href="pack__face__def_8h.html">pack_face_def.h</a>&gt;</span>        <span class="comment">// kernels for packing the ghost zones and general indexing</span>
<a name="l00162"></a>00162 <span class="preprocessor">#include &lt;<a class="code" href="staggered__dslash__def_8h.html">staggered_dslash_def.h</a>&gt;</span> <span class="comment">// staggered Dslash kernels</span>
<a name="l00163"></a>00163 <span class="preprocessor">#include &lt;<a class="code" href="wilson__dslash__def_8h.html">wilson_dslash_def.h</a>&gt;</span>    <span class="comment">// Wilson Dslash kernels (including clover)</span>
<a name="l00164"></a>00164 <span class="preprocessor">#include &lt;<a class="code" href="dw__dslash__def_8h.html">dw_dslash_def.h</a>&gt;</span>        <span class="comment">// Domain Wall kernels</span>
<a name="l00165"></a>00165 <span class="preprocessor">#include &lt;<a class="code" href="tm__dslash__def_8h.html">tm_dslash_def.h</a>&gt;</span>        <span class="comment">// Twisted Mass kernels</span>
<a name="l00166"></a>00166 <span class="preprocessor">#include &lt;<a class="code" href="tm__core_8h.html">tm_core.h</a>&gt;</span>              <span class="comment">// solo twisted mass kernel</span>
<a name="l00167"></a>00167 <span class="preprocessor">#include &lt;<a class="code" href="clover__def_8h.html">clover_def.h</a>&gt;</span>           <span class="comment">// kernels for applying the clover term alone</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="preprocessor">#ifndef DSLASH_SHARED_FLOATS_PER_THREAD</span>
<a name="l00170"></a><a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">00170</a> <span class="preprocessor"></span><span class="preprocessor">#define DSLASH_SHARED_FLOATS_PER_THREAD 0</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span>
<a name="l00173"></a>00173 <span class="preprocessor">#ifndef CLOVER_SHARED_FLOATS_PER_THREAD</span>
<a name="l00174"></a><a class="code" href="dslash__quda_8cu.html#a389d87f736b443d65d63dcd883e5f70b">00174</a> <span class="preprocessor"></span><span class="preprocessor">#define CLOVER_SHARED_FLOATS_PER_THREAD 0</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span>
<a name="l00177"></a>00177 <span class="preprocessor">#include &lt;<a class="code" href="blas__quda_8h.html">blas_quda.h</a>&gt;</span>
<a name="l00178"></a>00178 <span class="preprocessor">#include &lt;<a class="code" href="face__quda_8h.html">face_quda.h</a>&gt;</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="dslash__quda_8cu.html#a23cfa1dcb209d106050c0f374fae935e">00181</a> __global__ <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8cu.html#a23cfa1dcb209d106050c0f374fae935e">dummyKernel</a>() {
<a name="l00182"></a>00182   <span class="comment">// do nothing</span>
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="dslash__quda_8cu.html#a3243a99621b240c246a0052731d85f29">00185</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#a3243a99621b240c246a0052731d85f29">initCache</a>() {
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 200)</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span>
<a name="l00189"></a>00189   <span class="keyword">static</span> <span class="keywordtype">int</span> firsttime = 1;
<a name="l00190"></a>00190   <span class="keywordflow">if</span> (firsttime){       
<a name="l00191"></a>00191     cudaFuncSetCacheConfig(<a class="code" href="dslash__quda_8cu.html#a23cfa1dcb209d106050c0f374fae935e">dummyKernel</a>, cudaFuncCachePreferL1);
<a name="l00192"></a>00192     dummyKernel&lt;&lt;&lt;1,1&gt;&gt;&gt;();
<a name="l00193"></a>00193     firsttime=0;
<a name="l00194"></a>00194   }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="preprocessor">#endif</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="dslash__quda_8cu.html#afbd9b78c9c932ae17fcc54f22589f901">00200</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#aac995f6d97d538618e1be97c9bad18f5">setFace</a>(<span class="keyword">const</span> <a class="code" href="class_face_buffer.html">FaceBuffer</a> &amp;Face) {
<a name="l00201"></a>00201   face = (<a class="code" href="class_face_buffer.html">FaceBuffer</a>*)&amp;Face; <span class="comment">// nasty</span>
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="dslash__quda_8cu.html#aa9f80b24f244f51ed88f8d3d8bf77900">00204</a> <span class="preprocessor">#define MORE_GENERIC_DSLASH(FUNC, DAG, X, kernel_type, gridDim, blockDim, shared, stream, param,  ...)            \</span>
<a name="l00205"></a>00205 <span class="preprocessor">  if (x==0) {                                                                                                     \</span>
<a name="l00206"></a>00206 <span class="preprocessor">    if (reconstruct == QUDA_RECONSTRUCT_NO) {                                                                     \</span>
<a name="l00207"></a>00207 <span class="preprocessor">      FUNC ## 18 ## DAG ## Kernel&lt;kernel_type&gt;&lt;&lt;&lt;gridDim, blockDim, shared, stream&gt;&gt;&gt; ( __VA_ARGS__ , param);     \</span>
<a name="l00208"></a>00208 <span class="preprocessor">    } else if (reconstruct == QUDA_RECONSTRUCT_12) {                                                              \</span>
<a name="l00209"></a>00209 <span class="preprocessor">      FUNC ## 12 ## DAG ## Kernel&lt;kernel_type&gt;&lt;&lt;&lt;gridDim, blockDim, shared, stream&gt;&gt;&gt; ( __VA_ARGS__ , param);     \</span>
<a name="l00210"></a>00210 <span class="preprocessor">    } else {                                                                                                      \</span>
<a name="l00211"></a>00211 <span class="preprocessor">      FUNC ## 8 ## DAG ## Kernel&lt;kernel_type&gt;&lt;&lt;&lt;gridDim, blockDim, shared, stream&gt;&gt;&gt; ( __VA_ARGS__, param);       \</span>
<a name="l00212"></a>00212 <span class="preprocessor">    }                                                                                                             \</span>
<a name="l00213"></a>00213 <span class="preprocessor">  } else {                                                                                                        \</span>
<a name="l00214"></a>00214 <span class="preprocessor">    if (reconstruct == QUDA_RECONSTRUCT_NO) {                                                                     \</span>
<a name="l00215"></a>00215 <span class="preprocessor">      FUNC ## 18 ## DAG ## X ## Kernel&lt;kernel_type&gt;&lt;&lt;&lt;gridDim, blockDim, shared, stream&gt;&gt;&gt; ( __VA_ARGS__, param); \</span>
<a name="l00216"></a>00216 <span class="preprocessor">    } else if (reconstruct == QUDA_RECONSTRUCT_12) {                                                              \</span>
<a name="l00217"></a>00217 <span class="preprocessor">      FUNC ## 12 ## DAG ## X ## Kernel&lt;kernel_type&gt;&lt;&lt;&lt;gridDim, blockDim, shared, stream&gt;&gt;&gt; ( __VA_ARGS__, param); \</span>
<a name="l00218"></a>00218 <span class="preprocessor">    } else if (reconstruct == QUDA_RECONSTRUCT_8) {                                                               \</span>
<a name="l00219"></a>00219 <span class="preprocessor">      FUNC ## 8 ## DAG ## X ## Kernel&lt;kernel_type&gt; &lt;&lt;&lt;gridDim, blockDim, shared, stream&gt;&gt;&gt; ( __VA_ARGS__, param); \</span>
<a name="l00220"></a>00220 <span class="preprocessor">    }                                                                                                             \</span>
<a name="l00221"></a>00221 <span class="preprocessor">  }</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a>00223 <span class="preprocessor">#ifndef MULTI_GPU</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>
<a name="l00225"></a><a class="code" href="dslash__quda_8cu.html#adf5d9ddb267865169a3a40d762fa883d">00225</a> <span class="preprocessor">#define GENERIC_DSLASH(FUNC, DAG, X, gridDim, blockDim, shared, stream, param,  ...)                          \</span>
<a name="l00226"></a>00226 <span class="preprocessor">  switch(param.kernel_type) {                                                                                 \</span>
<a name="l00227"></a>00227 <span class="preprocessor">  case INTERIOR_KERNEL:                                                                                       \</span>
<a name="l00228"></a>00228 <span class="preprocessor">    MORE_GENERIC_DSLASH(FUNC, DAG, X, INTERIOR_KERNEL, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00229"></a>00229 <span class="preprocessor">    break;                                                                                                    \</span>
<a name="l00230"></a>00230 <span class="preprocessor">  default:                                                                                                    \</span>
<a name="l00231"></a>00231 <span class="preprocessor">    errorQuda(&quot;KernelType %d not defined for single GPU&quot;, param.kernel_type);                                 \</span>
<a name="l00232"></a>00232 <span class="preprocessor">  }</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>
<a name="l00234"></a>00234 <span class="preprocessor">#else</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>
<a name="l00236"></a>00236 <span class="preprocessor">#define GENERIC_DSLASH(FUNC, DAG, X, gridDim, blockDim, shared, stream, param,  ...)                            \</span>
<a name="l00237"></a>00237 <span class="preprocessor">  switch(param.kernel_type) {                                                                                   \</span>
<a name="l00238"></a>00238 <span class="preprocessor">  case INTERIOR_KERNEL:                                                                                         \</span>
<a name="l00239"></a>00239 <span class="preprocessor">    MORE_GENERIC_DSLASH(FUNC, DAG, X, INTERIOR_KERNEL,   gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00240"></a>00240 <span class="preprocessor">    break;                                                                                                      \</span>
<a name="l00241"></a>00241 <span class="preprocessor">  case EXTERIOR_KERNEL_X:                                                                                       \</span>
<a name="l00242"></a>00242 <span class="preprocessor">    MORE_GENERIC_DSLASH(FUNC, DAG, X, EXTERIOR_KERNEL_X, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00243"></a>00243 <span class="preprocessor">    break;                                                                                                      \</span>
<a name="l00244"></a>00244 <span class="preprocessor">  case EXTERIOR_KERNEL_Y:                                                                                       \</span>
<a name="l00245"></a>00245 <span class="preprocessor">    MORE_GENERIC_DSLASH(FUNC, DAG, X, EXTERIOR_KERNEL_Y, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00246"></a>00246 <span class="preprocessor">    break;                                                                                                      \</span>
<a name="l00247"></a>00247 <span class="preprocessor">  case EXTERIOR_KERNEL_Z:                                                                                       \</span>
<a name="l00248"></a>00248 <span class="preprocessor">    MORE_GENERIC_DSLASH(FUNC, DAG, X, EXTERIOR_KERNEL_Z, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00249"></a>00249 <span class="preprocessor">    break;                                                                                                      \</span>
<a name="l00250"></a>00250 <span class="preprocessor">  case EXTERIOR_KERNEL_T:                                                                                       \</span>
<a name="l00251"></a>00251 <span class="preprocessor">    MORE_GENERIC_DSLASH(FUNC, DAG, X, EXTERIOR_KERNEL_T, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00252"></a>00252 <span class="preprocessor">    break;                                                                                                      \</span>
<a name="l00253"></a>00253 <span class="preprocessor">  }</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>
<a name="l00255"></a>00255 <span class="preprocessor">#endif</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>
<a name="l00257"></a>00257 <span class="comment">// macro used for dslash types with dagger kernel defined (Wilson, domain wall, etc.)</span>
<a name="l00258"></a><a class="code" href="dslash__quda_8cu.html#aa3f3a0053cb5a4ca3d1a9f184516a1f4">00258</a> <span class="preprocessor">#define DSLASH(FUNC, gridDim, blockDim, shared, stream, param, ...)     \</span>
<a name="l00259"></a>00259 <span class="preprocessor">  if (!dagger) {                                                        \</span>
<a name="l00260"></a>00260 <span class="preprocessor">    GENERIC_DSLASH(FUNC, , Xpay, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00261"></a>00261 <span class="preprocessor">  } else {                                                              \</span>
<a name="l00262"></a>00262 <span class="preprocessor">    GENERIC_DSLASH(FUNC, Dagger, Xpay, gridDim, blockDim, shared, stream, param, __VA_ARGS__) \</span>
<a name="l00263"></a>00263 <span class="preprocessor"> }</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>
<a name="l00265"></a>00265 <span class="comment">// macro used for staggered dslash</span>
<a name="l00266"></a><a class="code" href="dslash__quda_8cu.html#a10df968466b9ce9f2b8321b7a0d2d4f3">00266</a> <span class="preprocessor">#define STAGGERED_DSLASH(gridDim, blockDim, shared, stream, param, ...) \</span>
<a name="l00267"></a>00267 <span class="preprocessor">    GENERIC_DSLASH(staggeredDslash, , Axpy, gridDim, blockDim, shared, stream, param, __VA_ARGS__)</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 <span class="comment">// Use an abstract class interface to drive the different CUDA dslash</span>
<a name="l00271"></a>00271 <span class="comment">// kernels. All parameters are curried into the derived classes to</span>
<a name="l00272"></a>00272 <span class="comment">// allow a simple interface.</span>
<a name="l00273"></a><a class="code" href="class_dslash_cuda.html">00273</a> <span class="keyword">class </span><a class="code" href="class_dslash_cuda.html">DslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_tunable.html">Tunable</a> {
<a name="l00274"></a>00274  <span class="keyword">protected</span>:
<a name="l00275"></a><a class="code" href="class_dslash_cuda.html#a382790db5a7725bcd0707b7e3d7869e1">00275</a>   <span class="keywordtype">int</span> <a class="code" href="class_dslash_cuda.html#a382790db5a7725bcd0707b7e3d7869e1">sharedBytesPerBlock</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 0; }
<a name="l00276"></a><a class="code" href="class_dslash_cuda.html#a49dbdc806984a25e7b42da7d8792ed4e">00276</a>   <span class="keywordtype">bool</span> <a class="code" href="class_dslash_cuda.html#a49dbdc806984a25e7b42da7d8792ed4e">advanceGridDim</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;<a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; } <span class="comment">// Don&#39;t tune the grid dimensions.</span>
<a name="l00277"></a><a class="code" href="class_dslash_cuda.html#a2b0f921135d78e1ddbcfa7cd41c70059">00277</a>   <span class="keywordtype">bool</span> <a class="code" href="class_dslash_cuda.html#a2b0f921135d78e1ddbcfa7cd41c70059">advanceBlockDim</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;<a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>)<span class="keyword"> const </span>{
<a name="l00278"></a>00278     <span class="keywordtype">bool</span> advance = <a class="code" href="class_dslash_cuda.html#a2b0f921135d78e1ddbcfa7cd41c70059">Tunable::advanceBlockDim</a>(param);
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (advance) param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a> = dim3( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l00280"></a>00280     <span class="keywordflow">return</span> advance;
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283  <span class="keyword">public</span>:
<a name="l00284"></a><a class="code" href="class_dslash_cuda.html#aecd82ee50b42e3bbe72a6eb548efad30">00284</a>   <a class="code" href="class_dslash_cuda.html#aecd82ee50b42e3bbe72a6eb548efad30">DslashCuda</a>() { }
<a name="l00285"></a><a class="code" href="class_dslash_cuda.html#a78d49396a32bc5de48cfa210fa216048">00285</a>   <span class="keyword">virtual</span> <a class="code" href="class_dslash_cuda.html#a78d49396a32bc5de48cfa210fa216048">~DslashCuda</a>() { }
<a name="l00286"></a>00286   <span class="keyword">virtual</span> <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_dslash_cuda.html#a7ea1a90edf57fe79b63e007e653bba8c">tuneKey</a>() <span class="keyword">const</span>;
<a name="l00287"></a><a class="code" href="class_dslash_cuda.html#a6d40a0e4a9e939a6c57eac1444d969cf">00287</a>   std::string <a class="code" href="class_dslash_cuda.html#a6d40a0e4a9e939a6c57eac1444d969cf">paramString</a>(<span class="keyword">const</span> <a class="code" href="class_tune_param.html">TuneParam</a> &amp;<a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>) <span class="keyword">const</span> <span class="comment">// Don&#39;t bother printing the grid dim.</span>
<a name="l00288"></a>00288   {
<a name="l00289"></a>00289     std::stringstream ps;
<a name="l00290"></a>00290     ps &lt;&lt; <span class="stringliteral">&quot;block=(&quot;</span> &lt;&lt; <a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>.block.x &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; <a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>.block.y &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; <a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>.block.z &lt;&lt; <span class="stringliteral">&quot;), &quot;</span>;
<a name="l00291"></a>00291     ps &lt;&lt; <span class="stringliteral">&quot;shared=&quot;</span> &lt;&lt; <a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>.shared_bytes;
<a name="l00292"></a>00292     <span class="keywordflow">return</span> ps.str();
<a name="l00293"></a>00293   }
<a name="l00294"></a><a class="code" href="class_dslash_cuda.html#a7b05c0482263bda3ee6aa303982addcc">00294</a>   <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="class_dslash_cuda.html#a7b05c0482263bda3ee6aa303982addcc">Nface</a>() { <span class="keywordflow">return</span> 2; }
<a name="l00295"></a>00295 
<a name="l00296"></a><a class="code" href="class_dslash_cuda.html#a4719906607f7d54272d258e24a34ee26">00296</a>   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_dslash_cuda.html#a4719906607f7d54272d258e24a34ee26">initTuneParam</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;<a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>)<span class="keyword"> const</span>
<a name="l00297"></a>00297 <span class="keyword">  </span>{
<a name="l00298"></a>00298     <a class="code" href="class_dslash_cuda.html#a4719906607f7d54272d258e24a34ee26">Tunable::initTuneParam</a>(param);
<a name="l00299"></a>00299     param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a> = dim3( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301 
<a name="l00303"></a><a class="code" href="class_dslash_cuda.html#ad05eec90ff726673c60bb02b652ee6af">00303</a>   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_dslash_cuda.html#ad05eec90ff726673c60bb02b652ee6af">defaultTuneParam</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;<a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>)<span class="keyword"> const</span>
<a name="l00304"></a>00304 <span class="keyword">  </span>{
<a name="l00305"></a>00305     <a class="code" href="class_dslash_cuda.html#ad05eec90ff726673c60bb02b652ee6af">Tunable::defaultTuneParam</a>(param);
<a name="l00306"></a>00306     param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a> = dim3( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l00307"></a>00307   }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 };
<a name="l00311"></a>00311 
<a name="l00312"></a><a class="code" href="class_dslash_cuda.html#a7ea1a90edf57fe79b63e007e653bba8c">00312</a> <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_dslash_cuda.html#a7ea1a90edf57fe79b63e007e653bba8c">DslashCuda::tuneKey</a>()<span class="keyword"> const</span>
<a name="l00313"></a>00313 <span class="keyword"></span>{
<a name="l00314"></a>00314   std::stringstream vol, <a class="code" href="tm__dslash__dagger__fermi__core_8h.html#a13307a0c81bbf19030ea4732534efbec">aux</a>;
<a name="l00315"></a>00315   
<a name="l00316"></a>00316   vol &lt;&lt; dslashConstants.x[0] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l00317"></a>00317   vol &lt;&lt; dslashConstants.x[1] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l00318"></a>00318   vol &lt;&lt; dslashConstants.x[2] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l00319"></a>00319   vol &lt;&lt; dslashConstants.x[3];
<a name="l00320"></a>00320 
<a name="l00321"></a>00321   aux &lt;&lt; <span class="stringliteral">&quot;type=&quot;</span>;
<a name="l00322"></a>00322 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span>  <span class="keywordtype">char</span> comm[5], ghost[5];
<a name="l00324"></a>00324   <span class="keywordflow">switch</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a>) {
<a name="l00325"></a>00325   <span class="keywordflow">case</span> <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>: aux &lt;&lt; <span class="stringliteral">&quot;interior&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00326"></a>00326   <span class="keywordflow">case</span> <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a57540634dba1984b627a5f1cc927b2d6">EXTERIOR_KERNEL_X</a>: aux &lt;&lt; <span class="stringliteral">&quot;exterior_x&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00327"></a>00327   <span class="keywordflow">case</span> <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a63c80cb0a79a4de2242fa357bdefa6cc">EXTERIOR_KERNEL_Y</a>: aux &lt;&lt; <span class="stringliteral">&quot;exterior_y&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00328"></a>00328   <span class="keywordflow">case</span> <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a84b6800b8dd2cf2c3ff5a32f6e410946">EXTERIOR_KERNEL_Z</a>: aux &lt;&lt; <span class="stringliteral">&quot;exterior_z&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00329"></a>00329   <span class="keywordflow">case</span> <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a018237f546d2e084c29e53c1c38f1234">EXTERIOR_KERNEL_T</a>: aux &lt;&lt; <span class="stringliteral">&quot;exterior_t&quot;</span>; <span class="keywordflow">break</span>;
<a name="l00330"></a>00330   }
<a name="l00331"></a>00331   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;4; i++) {
<a name="l00332"></a>00332     comm[i] = (dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i] ? <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>);
<a name="l00333"></a>00333     ghost[i] = (dslashParam.<a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">ghostDim</a>[i] ? <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>);
<a name="l00334"></a>00334   }
<a name="l00335"></a>00335   comm[4] = <span class="charliteral">&#39;\0&#39;</span>; ghost[4] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00336"></a>00336   aux &lt;&lt; <span class="stringliteral">&quot;,comm=&quot;</span> &lt;&lt; comm;
<a name="l00337"></a>00337   <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) {
<a name="l00338"></a>00338     aux &lt;&lt; <span class="stringliteral">&quot;,ghost=&quot;</span> &lt;&lt; ghost;
<a name="l00339"></a>00339   }
<a name="l00340"></a>00340 <span class="preprocessor">#else</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>  aux &lt;&lt; <span class="stringliteral">&quot;single-GPU&quot;</span>;
<a name="l00342"></a>00342 <span class="preprocessor">#endif // MULTI_GPU</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <a class="code" href="class_tune_key.html">TuneKey</a>(vol.str(), <span class="keyword">typeid</span>(*this).name(), aux.str());
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00349"></a>00349 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 200 &amp;&amp; defined(SHARED_WILSON_DSLASH)) </span>
<a name="l00350"></a>00350 <span class="preprocessor"></span><span class="keyword">class </span><a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_dslash_cuda.html">DslashCuda</a> {
<a name="l00351"></a>00351  <span class="keyword">protected</span>:
<a name="l00352"></a>00352   <span class="keywordtype">int</span> <a class="code" href="class_dslash_cuda.html#a382790db5a7725bcd0707b7e3d7869e1">sharedBytesPerBlock</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 0; } <span class="comment">// FIXME: this isn&#39;t quite true, but works</span>
<a name="l00353"></a>00353   <span class="keywordtype">bool</span> <a class="code" href="class_tunable.html#ac38427abaa5862045b8a546b67b7b435">advanceSharedBytes</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;<a class="code" href="pack__test_8cpp.html#aba126262dff054e28bac5c0d901769c8">param</a>)<span class="keyword"> const </span>{ 
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> != <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) <span class="keywordflow">return</span> <a class="code" href="class_tunable.html#ac38427abaa5862045b8a546b67b7b435">DslashCuda::advanceSharedBytes</a>(param);
<a name="l00355"></a>00355     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00356"></a>00356   } <span class="comment">// FIXME - shared memory tuning only supported on exterior kernels</span>
<a name="l00357"></a>00357 
<a name="l00359"></a>00359   <span class="keywordtype">int</span> sharedBytes(<span class="keyword">const</span> dim3 &amp;block)<span class="keyword"> const </span>{ 
<a name="l00360"></a>00360     <span class="keywordtype">int</span> warpSize = 32; <span class="comment">// FIXME - query from device properties</span>
<a name="l00361"></a>00361     <span class="keywordtype">int</span> block_xy = block.x*block.y;
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (block_xy % warpSize != 0) block_xy = ((block_xy / warpSize) + 1)*warpSize;
<a name="l00363"></a>00363     <span class="keywordflow">return</span> block_xy*block.z*<a class="code" href="class_tunable.html#a5398ba9ea6bc1207e370e5e9413edc3c">sharedBytesPerThread</a>();
<a name="l00364"></a>00364   }
<a name="l00365"></a>00365 
<a name="l00367"></a>00367   dim3 createGrid(<span class="keyword">const</span> dim3 &amp;block)<span class="keyword"> const </span>{
<a name="l00368"></a>00368     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gx = ((dslashConstants.x[0]/2)*dslashConstants.x[3] + block.x - 1) / block.x;
<a name="l00369"></a>00369     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gy = (dslashConstants.x[1] + block.y - 1 ) / block.y;  
<a name="l00370"></a>00370     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gz = (dslashConstants.x[2] + block.z - 1) / block.z;
<a name="l00371"></a>00371     <span class="keywordflow">return</span> dim3(gx, gy, gz);
<a name="l00372"></a>00372   }
<a name="l00373"></a>00373 
<a name="l00375"></a>00375   <span class="keywordtype">bool</span> <a class="code" href="class_dslash_cuda.html#a2b0f921135d78e1ddbcfa7cd41c70059">advanceBlockDim</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;param)<span class="keyword"> const </span>{
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> != <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) <span class="keywordflow">return</span> <a class="code" href="class_dslash_cuda.html#a2b0f921135d78e1ddbcfa7cd41c70059">DslashCuda::advanceBlockDim</a>(param);
<a name="l00377"></a>00377     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min_threads = 2;
<a name="l00378"></a>00378     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_threads = 512; <span class="comment">// FIXME: use deviceProp.maxThreadsDim[0];</span>
<a name="l00379"></a>00379     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max_shared = 16384*3; <span class="comment">// FIXME: use deviceProp.sharedMemPerBlock;</span>
<a name="l00380"></a>00380     
<a name="l00381"></a>00381     <span class="comment">// set the x-block dimension equal to the entire x dimension</span>
<a name="l00382"></a>00382     <span class="keywordtype">bool</span> <span class="keyword">set</span> = <span class="keyword">false</span>;
<a name="l00383"></a>00383     dim3 blockInit = param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>;
<a name="l00384"></a>00384     blockInit.z++;
<a name="l00385"></a>00385     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> bx=blockInit.x; bx&lt;=dslashConstants.x[0]/2; bx++) {
<a name="l00386"></a>00386       <span class="comment">//unsigned int gx = (dslashConstants.x[0]*dslashConstants.x[3] + bx - 1) / bx;</span>
<a name="l00387"></a>00387       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> by=blockInit.y; by&lt;=dslashConstants.x[1]; by++) {
<a name="l00388"></a>00388         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gy = (dslashConstants.x[1] + by - 1 ) / by;        
<a name="l00389"></a>00389         
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (by &gt; 1 &amp;&amp; (by%2) != 0) <span class="keywordflow">continue</span>; <span class="comment">// can&#39;t handle odd blocks yet except by=1</span>
<a name="l00391"></a>00391         
<a name="l00392"></a>00392         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> bz=blockInit.z; bz&lt;=dslashConstants.x[2]; bz++) {
<a name="l00393"></a>00393           <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> gz = (dslashConstants.x[2] + bz - 1) / bz;
<a name="l00394"></a>00394           
<a name="l00395"></a>00395           <span class="keywordflow">if</span> (bz &gt; 1 &amp;&amp; (bz%2) != 0) <span class="keywordflow">continue</span>; <span class="comment">// can&#39;t handle odd blocks yet except bz=1</span>
<a name="l00396"></a>00396           <span class="keywordflow">if</span> (bx*by*bz &gt; max_threads) <span class="keywordflow">continue</span>;
<a name="l00397"></a>00397           <span class="keywordflow">if</span> (bx*by*bz &lt; min_threads) <span class="keywordflow">continue</span>;
<a name="l00398"></a>00398           <span class="comment">// can&#39;t yet handle the last block properly in shared memory addressing</span>
<a name="l00399"></a>00399           <span class="keywordflow">if</span> (by*gy != dslashConstants.x[1]) <span class="keywordflow">continue</span>;
<a name="l00400"></a>00400           <span class="keywordflow">if</span> (bz*gz != dslashConstants.x[2]) <span class="keywordflow">continue</span>;
<a name="l00401"></a>00401           <span class="keywordflow">if</span> (sharedBytes(dim3(bx, by, bz)) &gt; max_shared) <span class="keywordflow">continue</span>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403           param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a> = dim3(bx, by, bz);         
<a name="l00404"></a>00404           <span class="keyword">set</span> = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406         <span class="keywordflow">if</span> (<span class="keyword">set</span>) <span class="keywordflow">break</span>;
<a name="l00407"></a>00407         blockInit.z = 1;
<a name="l00408"></a>00408       }
<a name="l00409"></a>00409       <span class="keywordflow">if</span> (<span class="keyword">set</span>) <span class="keywordflow">break</span>;
<a name="l00410"></a>00410       blockInit.y = 1;
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keywordflow">if</span> (param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x &gt; dslashConstants.x[0]/2 &amp;&amp; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.y &gt; dslashConstants.x[1] &amp;&amp;
<a name="l00414"></a>00414         param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.z &gt; dslashConstants.x[2] || !<span class="keyword">set</span>) {
<a name="l00415"></a>00415       <span class="comment">//||sharedBytesPerThread()*param.block.x &gt; max_shared) {</span>
<a name="l00416"></a>00416       param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a> = dim3(dslashConstants.x[0]/2, 1, 1);
<a name="l00417"></a>00417       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00418"></a>00418     } <span class="keywordflow">else</span> { 
<a name="l00419"></a>00419       param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a> = createGrid(param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>);
<a name="l00420"></a>00420       param.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a> = sharedBytes(param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>);
<a name="l00421"></a>00421       <span class="keywordflow">return</span> <span class="keyword">true</span>; 
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423     
<a name="l00424"></a>00424   }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426  <span class="keyword">public</span>:
<a name="l00427"></a>00427   <a class="code" href="class_shared_dslash_cuda.html#aa15e28981da21e776bb3f8becf5b878d">SharedDslashCuda</a>() : <a class="code" href="class_dslash_cuda.html">DslashCuda</a>() { ; }
<a name="l00428"></a>00428   <span class="keyword">virtual</span> <a class="code" href="class_shared_dslash_cuda.html#ac9e5d5def8024e6e9203c66335b1cc07">~SharedDslashCuda</a>() { ; }
<a name="l00429"></a>00429   std::string <a class="code" href="class_dslash_cuda.html#a6d40a0e4a9e939a6c57eac1444d969cf">paramString</a>(<span class="keyword">const</span> <a class="code" href="class_tune_param.html">TuneParam</a> &amp;param) <span class="keyword">const</span> <span class="comment">// override and print out grid as well</span>
<a name="l00430"></a>00430   {
<a name="l00431"></a>00431     std::stringstream ps;
<a name="l00432"></a>00432     ps &lt;&lt; <span class="stringliteral">&quot;block=(&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.y &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.z &lt;&lt; <span class="stringliteral">&quot;), &quot;</span>;
<a name="l00433"></a>00433     ps &lt;&lt; <span class="stringliteral">&quot;grid=(&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a>.x &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a>.y &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a>.z &lt;&lt; <span class="stringliteral">&quot;), &quot;</span>;
<a name="l00434"></a>00434     ps &lt;&lt; <span class="stringliteral">&quot;shared=&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>;
<a name="l00435"></a>00435     <span class="keywordflow">return</span> ps.str();
<a name="l00436"></a>00436   }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_dslash_cuda.html#a4719906607f7d54272d258e24a34ee26">initTuneParam</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;param)<span class="keyword"> const</span>
<a name="l00439"></a>00439 <span class="keyword">  </span>{
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> != <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) <span class="keywordflow">return</span> <a class="code" href="class_dslash_cuda.html#a4719906607f7d54272d258e24a34ee26">DslashCuda::initTuneParam</a>(param);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a> = dim3(dslashConstants.x[0]/2, 1, 1);
<a name="l00443"></a>00443     param.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a> = createGrid(param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>);
<a name="l00444"></a>00444     param.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a> = sharedBytes(param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>);
<a name="l00445"></a>00445   }
<a name="l00446"></a>00446 
<a name="l00448"></a>00448   <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="class_dslash_cuda.html#ad05eec90ff726673c60bb02b652ee6af">defaultTuneParam</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;param)<span class="keyword"> const</span>
<a name="l00449"></a>00449 <span class="keyword">  </span>{
<a name="l00450"></a>00450     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> != <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) <a class="code" href="class_dslash_cuda.html#ad05eec90ff726673c60bb02b652ee6af">DslashCuda::defaultTuneParam</a>(param);
<a name="l00451"></a>00451     <span class="keywordflow">else</span> <a class="code" href="class_dslash_cuda.html#a4719906607f7d54272d258e24a34ee26">initTuneParam</a>(param);
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453 };
<a name="l00454"></a>00454 <span class="preprocessor">#else </span>
<a name="l00455"></a><a class="code" href="class_shared_dslash_cuda.html">00455</a> <span class="preprocessor">class SharedDslashCuda : public DslashCuda {</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span> <span class="keyword">public</span>:
<a name="l00457"></a><a class="code" href="class_shared_dslash_cuda.html#aa15e28981da21e776bb3f8becf5b878d">00457</a>   <a class="code" href="class_shared_dslash_cuda.html#aa15e28981da21e776bb3f8becf5b878d">SharedDslashCuda</a>() : <a class="code" href="class_dslash_cuda.html">DslashCuda</a>() { }
<a name="l00458"></a><a class="code" href="class_shared_dslash_cuda.html#ac9e5d5def8024e6e9203c66335b1cc07">00458</a>   <span class="keyword">virtual</span> <a class="code" href="class_shared_dslash_cuda.html#ac9e5d5def8024e6e9203c66335b1cc07">~SharedDslashCuda</a>() { }
<a name="l00459"></a>00459 };
<a name="l00460"></a>00460 <span class="preprocessor">#endif</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat, <span class="keyword">typename</span> gFloat&gt;
<a name="l00464"></a><a class="code" href="class_wilson_dslash_cuda.html">00464</a> <span class="keyword">class </span><a class="code" href="class_wilson_dslash_cuda.html">WilsonDslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a> {
<a name="l00465"></a>00465 
<a name="l00466"></a>00466  <span class="keyword">private</span>:
<a name="l00467"></a>00467   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, norm_bytes;
<a name="l00468"></a>00468   sFloat *out;
<a name="l00469"></a>00469   <span class="keywordtype">float</span> *outNorm;
<a name="l00470"></a>00470   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l00471"></a>00471   <span class="keyword">const</span> sFloat *in, *x;
<a name="l00472"></a>00472   <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, *xNorm;
<a name="l00473"></a>00473   <span class="keyword">const</span> gFloat *gauge0, *gauge1;
<a name="l00474"></a>00474   <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct;
<a name="l00475"></a>00475   <span class="keyword">const</span> <span class="keywordtype">int</span> dagger;
<a name="l00476"></a>00476   <span class="keyword">const</span> <span class="keywordtype">double</span> a;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478  <span class="keyword">protected</span>:
<a name="l00479"></a><a class="code" href="class_wilson_dslash_cuda.html#a2790656c28eff1cc5fd1b71beb35f433">00479</a>   <span class="keywordtype">int</span> <a class="code" href="class_wilson_dslash_cuda.html#a2790656c28eff1cc5fd1b71beb35f433">sharedBytesPerThread</a>()<span class="keyword"> const</span>
<a name="l00480"></a>00480 <span class="keyword">  </span>{
<a name="l00481"></a>00481 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 200) // Fermi uses shared memory for common input</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) { <span class="comment">// Interior kernels use shared memory for common iunput</span>
<a name="l00483"></a>00483       <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00484"></a>00484       <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">DSLASH_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l00485"></a>00485     } <span class="keywordflow">else</span> { <span class="comment">// Exterior kernels use no shared memory</span>
<a name="l00486"></a>00486       <span class="keywordflow">return</span> 0;
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488 <span class="preprocessor">#else // Pre-Fermi uses shared memory only for pseudo-registers</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>    <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00490"></a>00490     <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">DSLASH_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l00491"></a>00491 <span class="preprocessor">#endif</span>
<a name="l00492"></a>00492 <span class="preprocessor"></span>  }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494  <span class="keyword">public</span>:
<a name="l00495"></a><a class="code" href="class_wilson_dslash_cuda.html#a6df712e0738472f8929408b0c017bc7f">00495</a>   <a class="code" href="class_wilson_dslash_cuda.html#a6df712e0738472f8929408b0c017bc7f">WilsonDslashCuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, <span class="keyword">const</span> gFloat *gauge0, <span class="keyword">const</span> gFloat *gauge1, 
<a name="l00496"></a>00496                    <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct, <span class="keyword">const</span> sFloat *in, <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm,
<a name="l00497"></a>00497                    <span class="keyword">const</span> sFloat *x, <span class="keyword">const</span> <span class="keywordtype">float</span> *xNorm, <span class="keyword">const</span> <span class="keywordtype">double</span> a,
<a name="l00498"></a>00498                    <span class="keyword">const</span> <span class="keywordtype">int</span> dagger, <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> norm_bytes)
<a name="l00499"></a>00499     : <a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a>(), bytes(bytes), norm_bytes(norm_bytes), out(out), outNorm(outNorm), gauge0(gauge0), gauge1(gauge1), in(in), 
<a name="l00500"></a>00500     inNorm(inNorm), reconstruct(reconstruct), dagger(dagger), x(x), xNorm(xNorm), a(a)
<a name="l00501"></a>00501   { 
<a name="l00502"></a>00502     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm, out, outNorm, x, xNorm); 
<a name="l00503"></a>00503   }
<a name="l00504"></a>00504 
<a name="l00505"></a><a class="code" href="class_wilson_dslash_cuda.html#ab749f202181240d3af83d8ba3ceeed10">00505</a>   <span class="keyword">virtual</span> <a class="code" href="class_wilson_dslash_cuda.html#ab749f202181240d3af83d8ba3ceeed10">~WilsonDslashCuda</a>() { <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm, out, outNorm, x, xNorm); }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="class_wilson_dslash_cuda.html#a1b08f51a5fd7bac262f2ec38df9553ba">00507</a>   <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_wilson_dslash_cuda.html#a1b08f51a5fd7bac262f2ec38df9553ba">tuneKey</a>()<span class="keyword"> const</span>
<a name="l00508"></a>00508 <span class="keyword">  </span>{
<a name="l00509"></a>00509     <a class="code" href="class_tune_key.html">TuneKey</a> key = <a class="code" href="class_wilson_dslash_cuda.html#a1b08f51a5fd7bac262f2ec38df9553ba">DslashCuda::tuneKey</a>();
<a name="l00510"></a>00510     std::stringstream recon;
<a name="l00511"></a>00511     recon &lt;&lt; reconstruct;
<a name="l00512"></a>00512     key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,reconstruct=&quot;</span> + recon.str();
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (x) key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,Xpay&quot;</span>;
<a name="l00514"></a>00514     <span class="keywordflow">return</span> key;
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="class_wilson_dslash_cuda.html#a00a8a23ade85c615fc81b871c9a59139">00517</a>   <span class="keywordtype">void</span> <a class="code" href="class_wilson_dslash_cuda.html#a00a8a23ade85c615fc81b871c9a59139">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>)
<a name="l00518"></a>00518   {
<a name="l00519"></a>00519 <span class="preprocessor">#ifdef SHARED_WILSON_DSLASH</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a57540634dba1984b627a5f1cc927b2d6">EXTERIOR_KERNEL_X</a>) 
<a name="l00521"></a>00521       <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Shared dslash does not yet support X-dimension partitioning&quot;</span>);
<a name="l00522"></a>00522 <span class="preprocessor">#endif</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>    <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l00524"></a>00524     <a class="code" href="dslash__quda_8cu.html#aa3f3a0053cb5a4ca3d1a9f184516a1f4">DSLASH</a>(<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>, tp.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a>, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream, dslashParam,
<a name="l00525"></a>00525            out, outNorm, gauge0, gauge1, in, inNorm, x, xNorm, a);
<a name="l00526"></a>00526   }
<a name="l00527"></a>00527 
<a name="l00528"></a><a class="code" href="class_wilson_dslash_cuda.html#aae1bd2c68535481d98b3ac1b540dab85">00528</a>   <span class="keywordtype">void</span> <a class="code" href="class_wilson_dslash_cuda.html#aae1bd2c68535481d98b3ac1b540dab85">preTune</a>()
<a name="l00529"></a>00529   {
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00531"></a>00531       saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l00532"></a>00532       cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l00533"></a>00533       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00534"></a>00534         saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l00535"></a>00535         cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l00536"></a>00536       }
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538   }
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="class_wilson_dslash_cuda.html#a3caea8d8e95f8aba26f5ef868ebc045d">00540</a>   <span class="keywordtype">void</span> <a class="code" href="class_wilson_dslash_cuda.html#a3caea8d8e95f8aba26f5ef868ebc045d">postTune</a>()
<a name="l00541"></a>00541   {
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00543"></a>00543       cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l00544"></a>00544       <span class="keyword">delete</span>[] saveOut;
<a name="l00545"></a>00545       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00546"></a>00546         cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l00547"></a>00547         <span class="keyword">delete</span>[] saveOutNorm;
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550   }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 };
<a name="l00553"></a>00553 
<a name="l00554"></a>00554 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat, <span class="keyword">typename</span> gFloat, <span class="keyword">typename</span> cFloat&gt;
<a name="l00555"></a><a class="code" href="class_clover_dslash_cuda.html">00555</a> <span class="keyword">class </span><a class="code" href="class_clover_dslash_cuda.html">CloverDslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a> {
<a name="l00556"></a>00556 
<a name="l00557"></a>00557  <span class="keyword">private</span>:
<a name="l00558"></a>00558   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, norm_bytes;
<a name="l00559"></a>00559   sFloat *out;
<a name="l00560"></a>00560   <span class="keywordtype">float</span> *outNorm;
<a name="l00561"></a>00561   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l00562"></a>00562   <span class="keyword">const</span> sFloat *in, *x;
<a name="l00563"></a>00563   <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, *xNorm;
<a name="l00564"></a>00564   <span class="keyword">const</span> gFloat *gauge0, *gauge1;
<a name="l00565"></a>00565   <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct;
<a name="l00566"></a>00566   <span class="keyword">const</span> cFloat *clover;
<a name="l00567"></a>00567   <span class="keyword">const</span> <span class="keywordtype">float</span> *cloverNorm;
<a name="l00568"></a>00568   <span class="keyword">const</span> <span class="keywordtype">int</span> dagger;
<a name="l00569"></a>00569   <span class="keyword">const</span> <span class="keywordtype">double</span> a;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571  <span class="keyword">protected</span>:
<a name="l00572"></a><a class="code" href="class_clover_dslash_cuda.html#a2dbc0d223f501b91e1055550ca6aee94">00572</a>   <span class="keywordtype">int</span> <a class="code" href="class_clover_dslash_cuda.html#a2dbc0d223f501b91e1055550ca6aee94">sharedBytesPerThread</a>()<span class="keyword"> const</span>
<a name="l00573"></a>00573 <span class="keyword">  </span>{
<a name="l00574"></a>00574 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 200)</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) {
<a name="l00576"></a>00576       <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00577"></a>00577       <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">DSLASH_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l00578"></a>00578     } <span class="keywordflow">else</span> {
<a name="l00579"></a>00579       <span class="keywordflow">return</span> 0;
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581 <span class="preprocessor">#else</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>    <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00583"></a>00583     <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">DSLASH_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l00584"></a>00584 <span class="preprocessor">#endif</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span>  }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587  <span class="keyword">public</span>:
<a name="l00588"></a><a class="code" href="class_clover_dslash_cuda.html#ad0fcab1a5ce0b2835fbd21ad76959407">00588</a>   <a class="code" href="class_clover_dslash_cuda.html#ad0fcab1a5ce0b2835fbd21ad76959407">CloverDslashCuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, <span class="keyword">const</span> gFloat *gauge0, <span class="keyword">const</span> gFloat *gauge1, 
<a name="l00589"></a>00589                    <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct, <span class="keyword">const</span> cFloat *clover, 
<a name="l00590"></a>00590                    <span class="keyword">const</span> <span class="keywordtype">float</span> *cloverNorm, <span class="keyword">const</span> sFloat *in, <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm,
<a name="l00591"></a>00591                    <span class="keyword">const</span> sFloat *x, <span class="keyword">const</span> <span class="keywordtype">float</span> *xNorm, <span class="keyword">const</span> <span class="keywordtype">double</span> a,
<a name="l00592"></a>00592                    <span class="keyword">const</span> <span class="keywordtype">int</span> dagger, <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> norm_bytes)
<a name="l00593"></a>00593     : <a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a>(), bytes(bytes), norm_bytes(norm_bytes), out(out), outNorm(outNorm), gauge0(gauge0), gauge1(gauge1), clover(clover),
<a name="l00594"></a>00594     cloverNorm(cloverNorm), in(in), inNorm(inNorm), reconstruct(reconstruct), dagger(dagger), x(x), xNorm(xNorm), a(a)
<a name="l00595"></a>00595   { 
<a name="l00596"></a>00596     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm, out, outNorm, x, xNorm); 
<a name="l00597"></a>00597   }
<a name="l00598"></a><a class="code" href="class_clover_dslash_cuda.html#a0ee062e26afe585e97256e4f9ffdee43">00598</a>   <span class="keyword">virtual</span> <a class="code" href="class_clover_dslash_cuda.html#a0ee062e26afe585e97256e4f9ffdee43">~CloverDslashCuda</a>() { <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm, out, outNorm, x, xNorm); }
<a name="l00599"></a>00599 
<a name="l00600"></a><a class="code" href="class_clover_dslash_cuda.html#a4a067a7ad87c12e2aba78ff5d84d3c7b">00600</a>   <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_clover_dslash_cuda.html#a4a067a7ad87c12e2aba78ff5d84d3c7b">tuneKey</a>()<span class="keyword"> const</span>
<a name="l00601"></a>00601 <span class="keyword">  </span>{
<a name="l00602"></a>00602     <a class="code" href="class_tune_key.html">TuneKey</a> key = <a class="code" href="class_clover_dslash_cuda.html#a4a067a7ad87c12e2aba78ff5d84d3c7b">DslashCuda::tuneKey</a>();
<a name="l00603"></a>00603     std::stringstream recon;
<a name="l00604"></a>00604     recon &lt;&lt; reconstruct;
<a name="l00605"></a>00605     key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,reconstruct=&quot;</span> + recon.str();
<a name="l00606"></a>00606     <span class="keywordflow">if</span> (x) key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,Xpay&quot;</span>;
<a name="l00607"></a>00607     <span class="keywordflow">return</span> key;
<a name="l00608"></a>00608   }
<a name="l00609"></a>00609 
<a name="l00610"></a><a class="code" href="class_clover_dslash_cuda.html#a549275e94f721978d702f75c5b7a10ae">00610</a>   <span class="keywordtype">void</span> <a class="code" href="class_clover_dslash_cuda.html#a549275e94f721978d702f75c5b7a10ae">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>)
<a name="l00611"></a>00611   {
<a name="l00612"></a>00612 <span class="preprocessor">#ifdef SHARED_WILSON_DSLASH</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a57540634dba1984b627a5f1cc927b2d6">EXTERIOR_KERNEL_X</a>) 
<a name="l00614"></a>00614       <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Shared dslash does not yet support X-dimension partitioning&quot;</span>);
<a name="l00615"></a>00615 <span class="preprocessor">#endif</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span>    <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l00617"></a>00617     <a class="code" href="dslash__quda_8cu.html#aa3f3a0053cb5a4ca3d1a9f184516a1f4">DSLASH</a>(cloverDslash, tp.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a>, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream, dslashParam,
<a name="l00618"></a>00618            out, outNorm, gauge0, gauge1, clover, cloverNorm, in, inNorm, x, xNorm, a);
<a name="l00619"></a>00619   }
<a name="l00620"></a>00620 
<a name="l00621"></a><a class="code" href="class_clover_dslash_cuda.html#ae8a3d496f45567a97a8c785a03302509">00621</a>   <span class="keywordtype">void</span> <a class="code" href="class_clover_dslash_cuda.html#ae8a3d496f45567a97a8c785a03302509">preTune</a>()
<a name="l00622"></a>00622   {
<a name="l00623"></a>00623     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00624"></a>00624       saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l00625"></a>00625       cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l00626"></a>00626       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00627"></a>00627         saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l00628"></a>00628         cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l00629"></a>00629       }
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631   }
<a name="l00632"></a>00632 
<a name="l00633"></a><a class="code" href="class_clover_dslash_cuda.html#ab4594218d6e3c302cc9bbc72a8c2770d">00633</a>   <span class="keywordtype">void</span> <a class="code" href="class_clover_dslash_cuda.html#ab4594218d6e3c302cc9bbc72a8c2770d">postTune</a>()
<a name="l00634"></a>00634   {
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00636"></a>00636       cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l00637"></a>00637       <span class="keyword">delete</span>[] saveOut;
<a name="l00638"></a>00638       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00639"></a>00639         cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l00640"></a>00640         <span class="keyword">delete</span>[] saveOutNorm;
<a name="l00641"></a>00641       }
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643   }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 };
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="dslash__quda_8cu.html#ab3c21c78c1c28525ac8c11965f9c1c3f">00647</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8cu.html#ab3c21c78c1c28525ac8c11965f9c1c3f">setTwistParam</a>(<span class="keywordtype">double</span> &amp;a, <span class="keywordtype">double</span> &amp;b, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;<a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;<a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, 
<a name="l00648"></a>00648                    <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a30b3cbc1972d202433ed6582d86a5391">QudaTwistGamma5Type</a> twist) {
<a name="l00649"></a>00649   <span class="keywordflow">if</span> (twist == <a class="code" href="enum__quda_8h.html#ab8ef3810ffdf1247c071489d6f2839cea583d9519ec0fe19476b665d7408ffb87">QUDA_TWIST_GAMMA5_DIRECT</a>) {
<a name="l00650"></a>00650     a = 2.0 * kappa * <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>;
<a name="l00651"></a>00651     b = 1.0;
<a name="l00652"></a>00652   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (twist == <a class="code" href="enum__quda_8h.html#ab8ef3810ffdf1247c071489d6f2839cea35cdae477dd2ba5a2c4e87e53afc2e76">QUDA_TWIST_GAMMA5_INVERSE</a>) {
<a name="l00653"></a>00653     a = -2.0 * kappa * <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>;
<a name="l00654"></a>00654     b = 1.0 / (1.0 + a*a);
<a name="l00655"></a>00655   } <span class="keywordflow">else</span> {
<a name="l00656"></a>00656     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Twist type %d not defined\n&quot;</span>, twist);
<a name="l00657"></a>00657   }
<a name="l00658"></a>00658   <span class="keywordflow">if</span> (dagger) a *= -1.0;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat, <span class="keyword">typename</span> gFloat&gt;
<a name="l00663"></a><a class="code" href="class_twisted_dslash_cuda.html">00663</a> <span class="keyword">class </span><a class="code" href="class_twisted_dslash_cuda.html">TwistedDslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a> {
<a name="l00664"></a>00664 
<a name="l00665"></a>00665  <span class="keyword">private</span>:
<a name="l00666"></a>00666   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, norm_bytes;
<a name="l00667"></a>00667   sFloat *out;
<a name="l00668"></a>00668   <span class="keywordtype">float</span> *outNorm;
<a name="l00669"></a>00669   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l00670"></a>00670   <span class="keyword">const</span> sFloat *in, *x;
<a name="l00671"></a>00671   <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, *xNorm;
<a name="l00672"></a>00672   <span class="keyword">const</span> gFloat *gauge0, *gauge1;
<a name="l00673"></a>00673   <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct;
<a name="l00674"></a>00674   <span class="keyword">const</span> <span class="keywordtype">int</span> dagger;
<a name="l00675"></a>00675   <span class="keywordtype">double</span> a;
<a name="l00676"></a>00676   <span class="keywordtype">double</span> b;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678  <span class="keyword">protected</span>:
<a name="l00679"></a><a class="code" href="class_twisted_dslash_cuda.html#a0256ffd0bc2d6e6ea07dd09393c709a5">00679</a>   <span class="keywordtype">int</span> <a class="code" href="class_twisted_dslash_cuda.html#a0256ffd0bc2d6e6ea07dd09393c709a5">sharedBytesPerThread</a>()<span class="keyword"> const</span>
<a name="l00680"></a>00680 <span class="keyword">  </span>{
<a name="l00681"></a>00681 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 200)</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>) {
<a name="l00683"></a>00683       <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00684"></a>00684       <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">DSLASH_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l00685"></a>00685     } <span class="keywordflow">else</span> {
<a name="l00686"></a>00686       <span class="keywordflow">return</span> 0;
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 <span class="preprocessor">#else</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>    <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00690"></a>00690     <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a49c0f0ba9b71078ce50197cdc069647d">DSLASH_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l00691"></a>00691 <span class="preprocessor">#endif</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>  }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694  <span class="keyword">public</span>:
<a name="l00695"></a><a class="code" href="class_twisted_dslash_cuda.html#aaf162e00fd7cbbc8e65c2928499aebfe">00695</a>   <a class="code" href="class_twisted_dslash_cuda.html#aaf162e00fd7cbbc8e65c2928499aebfe">TwistedDslashCuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, <span class="keyword">const</span> gFloat *gauge0, <span class="keyword">const</span> gFloat *gauge1, 
<a name="l00696"></a>00696                     <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct, <span class="keyword">const</span> sFloat *in, <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm,
<a name="l00697"></a>00697                     <span class="keyword">const</span> sFloat *x, <span class="keyword">const</span> <span class="keywordtype">float</span> *xNorm, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>,
<a name="l00698"></a>00698                     <span class="keyword">const</span> <span class="keywordtype">double</span> k, <span class="keyword">const</span> <span class="keywordtype">int</span> dagger, <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> norm_bytes)
<a name="l00699"></a>00699     : <a class="code" href="class_shared_dslash_cuda.html">SharedDslashCuda</a>(), bytes(bytes), norm_bytes(norm_bytes), out(out), outNorm(outNorm), gauge0(gauge0), gauge1(gauge1), in(in),
<a name="l00700"></a>00700     inNorm(inNorm), reconstruct(reconstruct), dagger(dagger), x(x), xNorm(xNorm)
<a name="l00701"></a>00701   { 
<a name="l00702"></a>00702     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm, out, outNorm, x, xNorm); 
<a name="l00703"></a>00703     <a class="code" href="dslash__quda_8cu.html#ab3c21c78c1c28525ac8c11965f9c1c3f">setTwistParam</a>(a, b, kappa, mu, dagger, <a class="code" href="enum__quda_8h.html#ab8ef3810ffdf1247c071489d6f2839cea35cdae477dd2ba5a2c4e87e53afc2e76">QUDA_TWIST_GAMMA5_INVERSE</a>);
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (x) b *= k;
<a name="l00705"></a>00705   }
<a name="l00706"></a><a class="code" href="class_twisted_dslash_cuda.html#a8f28cbaa7f630513a8ec1249a6fb290c">00706</a>   <span class="keyword">virtual</span> <a class="code" href="class_twisted_dslash_cuda.html#a8f28cbaa7f630513a8ec1249a6fb290c">~TwistedDslashCuda</a>() { <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm, out, outNorm, x, xNorm); }
<a name="l00707"></a>00707 
<a name="l00708"></a><a class="code" href="class_twisted_dslash_cuda.html#a6bec5373a2bb7229dea5895368fa18d9">00708</a>   <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_twisted_dslash_cuda.html#a6bec5373a2bb7229dea5895368fa18d9">tuneKey</a>()<span class="keyword"> const</span>
<a name="l00709"></a>00709 <span class="keyword">  </span>{
<a name="l00710"></a>00710     <a class="code" href="class_tune_key.html">TuneKey</a> key = <a class="code" href="class_twisted_dslash_cuda.html#a6bec5373a2bb7229dea5895368fa18d9">DslashCuda::tuneKey</a>();
<a name="l00711"></a>00711     std::stringstream recon;
<a name="l00712"></a>00712     recon &lt;&lt; reconstruct;
<a name="l00713"></a>00713     key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,reconstruct=&quot;</span> + recon.str();
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (x) key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,Xpay&quot;</span>;
<a name="l00715"></a>00715     <span class="keywordflow">return</span> key;
<a name="l00716"></a>00716   }
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="class_twisted_dslash_cuda.html#ae19f1328542eb9785de126e42330e231">00718</a>   <span class="keywordtype">void</span> <a class="code" href="class_twisted_dslash_cuda.html#ae19f1328542eb9785de126e42330e231">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>)
<a name="l00719"></a>00719   {
<a name="l00720"></a>00720 <span class="preprocessor">#ifdef SHARED_WILSON_DSLASH</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> == <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a57540634dba1984b627a5f1cc927b2d6">EXTERIOR_KERNEL_X</a>) 
<a name="l00722"></a>00722       <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Shared dslash does not yet support X-dimension partitioning&quot;</span>);
<a name="l00723"></a>00723 <span class="preprocessor">#endif</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span>    <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l00725"></a>00725     <a class="code" href="dslash__quda_8cu.html#aa3f3a0053cb5a4ca3d1a9f184516a1f4">DSLASH</a>(twistedMassDslash, tp.<a class="code" href="class_tune_param.html#a8cff46997e2a12c47f25a5f617559376">grid</a>, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream, dslashParam,
<a name="l00726"></a>00726            out, outNorm, gauge0, gauge1, in, inNorm, a, b, x, xNorm);
<a name="l00727"></a>00727   }
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="class_twisted_dslash_cuda.html#a362d97064c4384278321e0bd3ad0addd">00729</a>   <span class="keywordtype">void</span> <a class="code" href="class_twisted_dslash_cuda.html#a362d97064c4384278321e0bd3ad0addd">preTune</a>()
<a name="l00730"></a>00730   {
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00732"></a>00732       saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l00733"></a>00733       cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l00734"></a>00734       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00735"></a>00735         saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l00736"></a>00736         cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l00737"></a>00737       }
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739   }
<a name="l00740"></a>00740 
<a name="l00741"></a><a class="code" href="class_twisted_dslash_cuda.html#a96758288f7c231db48a49584a8a90b4f">00741</a>   <span class="keywordtype">void</span> <a class="code" href="class_twisted_dslash_cuda.html#a96758288f7c231db48a49584a8a90b4f">postTune</a>()
<a name="l00742"></a>00742   {
<a name="l00743"></a>00743     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00744"></a>00744       cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l00745"></a>00745       <span class="keyword">delete</span>[] saveOut;
<a name="l00746"></a>00746       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00747"></a>00747         cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l00748"></a>00748         <span class="keyword">delete</span>[] saveOutNorm;
<a name="l00749"></a>00749       }
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751   }
<a name="l00752"></a>00752 };
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat, <span class="keyword">typename</span> gFloat&gt;
<a name="l00755"></a><a class="code" href="class_domain_wall_dslash_cuda.html">00755</a> <span class="keyword">class </span><a class="code" href="class_domain_wall_dslash_cuda.html">DomainWallDslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_dslash_cuda.html">DslashCuda</a> {
<a name="l00756"></a>00756 
<a name="l00757"></a>00757  <span class="keyword">private</span>:
<a name="l00758"></a>00758   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, norm_bytes;
<a name="l00759"></a>00759   sFloat *out;
<a name="l00760"></a>00760   <span class="keywordtype">float</span> *outNorm;
<a name="l00761"></a>00761   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l00762"></a>00762   <span class="keyword">const</span> sFloat *in, *x;
<a name="l00763"></a>00763   <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, *xNorm;
<a name="l00764"></a>00764   <span class="keyword">const</span> gFloat *gauge0, *gauge1;
<a name="l00765"></a>00765   <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct;
<a name="l00766"></a>00766   <span class="keyword">const</span> <span class="keywordtype">int</span> dagger;
<a name="l00767"></a>00767   <span class="keyword">const</span> <span class="keywordtype">double</span> mferm;
<a name="l00768"></a>00768   <span class="keyword">const</span> <span class="keywordtype">double</span> a;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770  <span class="keyword">protected</span>:
<a name="l00771"></a><a class="code" href="class_domain_wall_dslash_cuda.html#aefd89733a59b2bcc4ddbbcdad7fe25aa">00771</a>   <span class="keywordtype">int</span> <a class="code" href="class_domain_wall_dslash_cuda.html#aefd89733a59b2bcc4ddbbcdad7fe25aa">sharedBytesPerThread</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 0; }
<a name="l00772"></a>00772   
<a name="l00773"></a>00773  <span class="keyword">public</span>:
<a name="l00774"></a><a class="code" href="class_domain_wall_dslash_cuda.html#a5a0b2874dff86bd401ae291038aadf92">00774</a>   <a class="code" href="class_domain_wall_dslash_cuda.html#a5a0b2874dff86bd401ae291038aadf92">DomainWallDslashCuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, <span class="keyword">const</span> gFloat *gauge0, <span class="keyword">const</span> gFloat *gauge1, 
<a name="l00775"></a>00775                        <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct, <span class="keyword">const</span> sFloat *in, 
<a name="l00776"></a>00776                        <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, <span class="keyword">const</span> sFloat *x, <span class="keyword">const</span> <span class="keywordtype">float</span> *xNorm, <span class="keyword">const</span> <span class="keywordtype">double</span> mferm, 
<a name="l00777"></a>00777                        <span class="keyword">const</span> <span class="keywordtype">double</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> dagger, <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> norm_bytes)
<a name="l00778"></a>00778     : <a class="code" href="class_dslash_cuda.html">DslashCuda</a>(), bytes(bytes), norm_bytes(norm_bytes), out(out), outNorm(outNorm), gauge0(gauge0), gauge1(gauge1), 
<a name="l00779"></a>00779     in(in), inNorm(inNorm), mferm(mferm), reconstruct(reconstruct), dagger(dagger), x(x), xNorm(xNorm), a(a)
<a name="l00780"></a>00780   { 
<a name="l00781"></a>00781     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm, out, outNorm, x, xNorm); 
<a name="l00782"></a>00782   }
<a name="l00783"></a><a class="code" href="class_domain_wall_dslash_cuda.html#aa6f2f3f846dcdb61e7d41db48efa405d">00783</a>   <span class="keyword">virtual</span> <a class="code" href="class_domain_wall_dslash_cuda.html#aa6f2f3f846dcdb61e7d41db48efa405d">~DomainWallDslashCuda</a>() { <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm, out, outNorm, x, xNorm); }
<a name="l00784"></a>00784 
<a name="l00785"></a><a class="code" href="class_domain_wall_dslash_cuda.html#a1a41118f04a8e6b3516d33d3146c54d3">00785</a>   <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_domain_wall_dslash_cuda.html#a1a41118f04a8e6b3516d33d3146c54d3">tuneKey</a>()<span class="keyword"> const</span>
<a name="l00786"></a>00786 <span class="keyword">  </span>{
<a name="l00787"></a>00787     <a class="code" href="class_tune_key.html">TuneKey</a> key = <a class="code" href="class_domain_wall_dslash_cuda.html#a1a41118f04a8e6b3516d33d3146c54d3">DslashCuda::tuneKey</a>();
<a name="l00788"></a>00788     std::stringstream ls, recon;
<a name="l00789"></a>00789     ls &lt;&lt; dslashConstants.Ls;
<a name="l00790"></a>00790     recon &lt;&lt; reconstruct;
<a name="l00791"></a>00791     key.<a class="code" href="class_tune_key.html#a654ae3a7e3cb3b7d03c342fda4ae2480">volume</a> += <span class="stringliteral">&quot;x&quot;</span> + ls.str();
<a name="l00792"></a>00792     key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,reconstruct=&quot;</span> + recon.str();
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (x) key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,Xpay&quot;</span>;
<a name="l00794"></a>00794     <span class="keywordflow">return</span> key;
<a name="l00795"></a>00795   }
<a name="l00796"></a>00796 
<a name="l00797"></a><a class="code" href="class_domain_wall_dslash_cuda.html#a391330e1258ee3cd4e4cea101cfd0fa0">00797</a>   <span class="keywordtype">void</span> <a class="code" href="class_domain_wall_dslash_cuda.html#a391330e1258ee3cd4e4cea101cfd0fa0">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>)
<a name="l00798"></a>00798   {
<a name="l00799"></a>00799     <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l00800"></a>00800     dim3 gridDim( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l00801"></a>00801     <a class="code" href="dslash__quda_8cu.html#aa3f3a0053cb5a4ca3d1a9f184516a1f4">DSLASH</a>(domainWallDslash, gridDim, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream, dslashParam,
<a name="l00802"></a>00802            out, outNorm, gauge0, gauge1, in, inNorm, mferm, x, xNorm, a);
<a name="l00803"></a>00803   }
<a name="l00804"></a>00804 
<a name="l00805"></a><a class="code" href="class_domain_wall_dslash_cuda.html#af76e10fae99a371c710cfaa6621f5a40">00805</a>   <span class="keywordtype">void</span> <a class="code" href="class_domain_wall_dslash_cuda.html#af76e10fae99a371c710cfaa6621f5a40">preTune</a>()
<a name="l00806"></a>00806   {
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00808"></a>00808       saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l00809"></a>00809       cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l00810"></a>00810       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00811"></a>00811         saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l00812"></a>00812         cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l00813"></a>00813       }
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815   }
<a name="l00816"></a>00816 
<a name="l00817"></a><a class="code" href="class_domain_wall_dslash_cuda.html#ac84e64551b68559fb1cdd8bca239feee">00817</a>   <span class="keywordtype">void</span> <a class="code" href="class_domain_wall_dslash_cuda.html#ac84e64551b68559fb1cdd8bca239feee">postTune</a>()
<a name="l00818"></a>00818   {
<a name="l00819"></a>00819     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00820"></a>00820       cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l00821"></a>00821       <span class="keyword">delete</span>[] saveOut;
<a name="l00822"></a>00822       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l00823"></a>00823         cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l00824"></a>00824         <span class="keyword">delete</span>[] saveOutNorm;
<a name="l00825"></a>00825       }
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827   }
<a name="l00828"></a>00828 };
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat, <span class="keyword">typename</span> fatGFloat, <span class="keyword">typename</span> <span class="keywordtype">long</span>GFloat&gt;
<a name="l00831"></a><a class="code" href="class_staggered_dslash_cuda.html">00831</a> <span class="keyword">class </span><a class="code" href="class_staggered_dslash_cuda.html">StaggeredDslashCuda</a> : <span class="keyword">public</span> <a class="code" href="class_dslash_cuda.html">DslashCuda</a> {
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 <span class="keyword">private</span>:
<a name="l00834"></a>00834   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, norm_bytes;
<a name="l00835"></a>00835   sFloat *out;
<a name="l00836"></a>00836   <span class="keywordtype">float</span> *outNorm;
<a name="l00837"></a>00837   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l00838"></a>00838   <span class="keyword">const</span> sFloat *in, *x;
<a name="l00839"></a>00839   <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, *xNorm;
<a name="l00840"></a>00840   <span class="keyword">const</span> fatGFloat *fat0, *fat1;
<a name="l00841"></a>00841   <span class="keyword">const</span> longGFloat *long0, *long1;
<a name="l00842"></a>00842   <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct;
<a name="l00843"></a>00843   <span class="keyword">const</span> <span class="keywordtype">int</span> dagger;
<a name="l00844"></a>00844   <span class="keyword">const</span> <span class="keywordtype">double</span> a;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846  <span class="keyword">protected</span>:
<a name="l00847"></a><a class="code" href="class_staggered_dslash_cuda.html#a092d3bd4a7da4aeba5f8a14e2b0cb7a1">00847</a>   <span class="keywordtype">int</span> <a class="code" href="class_staggered_dslash_cuda.html#a092d3bd4a7da4aeba5f8a14e2b0cb7a1">sharedBytesPerThread</a>()<span class="keyword"> const</span>
<a name="l00848"></a>00848 <span class="keyword">  </span>{
<a name="l00849"></a>00849     <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00850"></a>00850     <span class="keywordflow">return</span> 6 * reg_size;
<a name="l00851"></a>00851   }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853  <span class="keyword">public</span>:
<a name="l00854"></a><a class="code" href="class_staggered_dslash_cuda.html#abc8592cb30f6b6f862622848f77c9172">00854</a>   <a class="code" href="class_staggered_dslash_cuda.html#abc8592cb30f6b6f862622848f77c9172">StaggeredDslashCuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, <span class="keyword">const</span> fatGFloat *fat0, <span class="keyword">const</span> fatGFloat *fat1,
<a name="l00855"></a>00855                       <span class="keyword">const</span> longGFloat *long0, <span class="keyword">const</span> longGFloat *long1,
<a name="l00856"></a>00856                       <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a829ee8aa93bd9465811ae1ef9e0eedcc">QudaReconstructType</a> reconstruct, <span class="keyword">const</span> sFloat *in, 
<a name="l00857"></a>00857                       <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, <span class="keyword">const</span> sFloat *x, <span class="keyword">const</span> <span class="keywordtype">float</span> *xNorm, <span class="keyword">const</span> <span class="keywordtype">double</span> a,
<a name="l00858"></a>00858                       <span class="keyword">const</span> <span class="keywordtype">int</span> dagger, <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> norm_bytes)
<a name="l00859"></a>00859     : <a class="code" href="class_dslash_cuda.html">DslashCuda</a>(), bytes(bytes), norm_bytes(norm_bytes), out(out), outNorm(outNorm), fat0(fat0), fat1(fat1), long0(long0), long1(long1),
<a name="l00860"></a>00860     in(in), inNorm(inNorm), reconstruct(reconstruct), dagger(dagger), x(x), xNorm(xNorm), a(a)
<a name="l00861"></a>00861   { 
<a name="l00862"></a>00862     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm, out, outNorm, x, xNorm); 
<a name="l00863"></a>00863   }
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="class_staggered_dslash_cuda.html#a739ba9a87066287aa604d4d7af9324f4">00865</a>   <span class="keyword">virtual</span> <a class="code" href="class_staggered_dslash_cuda.html#a739ba9a87066287aa604d4d7af9324f4">~StaggeredDslashCuda</a>() { <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm, out, outNorm, x, xNorm); }
<a name="l00866"></a>00866 
<a name="l00867"></a><a class="code" href="class_staggered_dslash_cuda.html#a7704e6d1bd5ca490d68f51052be4a961">00867</a>   <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_staggered_dslash_cuda.html#a7704e6d1bd5ca490d68f51052be4a961">tuneKey</a>()<span class="keyword"> const</span>
<a name="l00868"></a>00868 <span class="keyword">  </span>{
<a name="l00869"></a>00869     <a class="code" href="class_tune_key.html">TuneKey</a> key = <a class="code" href="class_staggered_dslash_cuda.html#a7704e6d1bd5ca490d68f51052be4a961">DslashCuda::tuneKey</a>();
<a name="l00870"></a>00870     std::stringstream recon;
<a name="l00871"></a>00871     recon &lt;&lt; reconstruct;
<a name="l00872"></a>00872     key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,reconstruct=&quot;</span> + recon.str();
<a name="l00873"></a>00873     <span class="keywordflow">if</span> (x) key.<a class="code" href="class_tune_key.html#a291ceb670accde0ddfb1e5443e6920dc">aux</a> += <span class="stringliteral">&quot;,Axpy&quot;</span>;
<a name="l00874"></a>00874     <span class="keywordflow">return</span> key;
<a name="l00875"></a>00875   }
<a name="l00876"></a>00876 
<a name="l00877"></a><a class="code" href="class_staggered_dslash_cuda.html#a1b06fc027db985e5ea0b6899e2cb0e19">00877</a>   <span class="keywordtype">void</span> <a class="code" href="class_staggered_dslash_cuda.html#a1b06fc027db985e5ea0b6899e2cb0e19">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>)
<a name="l00878"></a>00878   {
<a name="l00879"></a>00879     <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l00880"></a>00880     dim3 gridDim( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l00881"></a>00881     <a class="code" href="dslash__quda_8cu.html#a10df968466b9ce9f2b8321b7a0d2d4f3">STAGGERED_DSLASH</a>(gridDim, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream, dslashParam,
<a name="l00882"></a>00882                      out, outNorm, fat0, fat1, long0, long1, in, inNorm, x, xNorm, a);
<a name="l00883"></a>00883   }
<a name="l00884"></a>00884 
<a name="l00885"></a><a class="code" href="class_staggered_dslash_cuda.html#a80fab165fd912a8cf4723ed3b5a56ff4">00885</a>   <span class="keywordtype">void</span> <a class="code" href="class_staggered_dslash_cuda.html#a80fab165fd912a8cf4723ed3b5a56ff4">preTune</a>()
<a name="l00886"></a>00886   {
<a name="l00887"></a>00887     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00888"></a>00888       saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l00889"></a>00889       cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l00890"></a>00890       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short2)) {
<a name="l00891"></a>00891         saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l00892"></a>00892         cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l00893"></a>00893       }
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895   }
<a name="l00896"></a>00896 
<a name="l00897"></a><a class="code" href="class_staggered_dslash_cuda.html#af4c42d17662b78e497ffba58b547a710">00897</a>   <span class="keywordtype">void</span> <a class="code" href="class_staggered_dslash_cuda.html#af4c42d17662b78e497ffba58b547a710">postTune</a>()
<a name="l00898"></a>00898   {
<a name="l00899"></a>00899     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> &lt; 5) { <span class="comment">// exterior kernel</span>
<a name="l00900"></a>00900       cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l00901"></a>00901       <span class="keyword">delete</span>[] saveOut;
<a name="l00902"></a>00902       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short2)) {
<a name="l00903"></a>00903         cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l00904"></a>00904         <span class="keyword">delete</span>[] saveOutNorm;
<a name="l00905"></a>00905       }
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907   }
<a name="l00908"></a>00908 
<a name="l00909"></a><a class="code" href="class_staggered_dslash_cuda.html#a7efbe251ed59c6d5aae9acaf60e3c3cb">00909</a>   <span class="keywordtype">int</span> <a class="code" href="class_staggered_dslash_cuda.html#a7efbe251ed59c6d5aae9acaf60e3c3cb">Nface</a>() { <span class="keywordflow">return</span> 6; }
<a name="l00910"></a>00910 };
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="preprocessor">#ifdef DSLASH_PROFILING</span>
<a name="l00913"></a>00913 <span class="preprocessor"></span>
<a name="l00914"></a>00914 <span class="preprocessor">#define TDIFF(a,b) 1e3*(b.tv_sec - a.tv_sec + 1e-6*(b.tv_usec - a.tv_usec))</span>
<a name="l00915"></a>00915 <span class="preprocessor"></span>
<a name="l00916"></a>00916 <span class="keywordtype">void</span> dslashTimeProfile() {
<a name="l00917"></a>00917 
<a name="l00918"></a>00918   cudaEventSynchronize(dslashEnd);
<a name="l00919"></a>00919   <span class="keywordtype">float</span> runTime;
<a name="l00920"></a>00920   cudaEventElapsedTime(&amp;runTime, dslashStart, dslashEnd);
<a name="l00921"></a>00921   dslashTime += runTime;
<a name="l00922"></a>00922 
<a name="l00923"></a>00923   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=4; i&gt;=0; i--) {
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i] &amp;&amp; i&lt;4) <span class="keywordflow">continue</span>;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="comment">// kernel timing</span>
<a name="l00927"></a>00927     cudaEventElapsedTime(&amp;runTime, dslashStart, kernelStart[2*i]);
<a name="l00928"></a>00928     kernelTime[2*i][0] += runTime; <span class="comment">// start time</span>
<a name="l00929"></a>00929     cudaEventElapsedTime(&amp;runTime, dslashStart, kernelEnd[2*i]);
<a name="l00930"></a>00930     kernelTime[2*i][1] += runTime; <span class="comment">// end time</span>
<a name="l00931"></a>00931   }
<a name="l00932"></a>00932       
<a name="l00933"></a>00933 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l00934"></a>00934 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=3; i&gt;=0; i--) {
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) <span class="keywordflow">continue</span>;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; 2; dir ++) {
<a name="l00938"></a>00938       <span class="comment">// pack timing</span>
<a name="l00939"></a>00939       cudaEventElapsedTime(&amp;runTime, dslashStart, packStart[2*i+dir]);
<a name="l00940"></a>00940       packTime[2*i+dir][0] += runTime; <span class="comment">// start time</span>
<a name="l00941"></a>00941       cudaEventElapsedTime(&amp;runTime, dslashStart, packEnd[2*i+dir]);
<a name="l00942"></a>00942       packTime[2*i+dir][1] += runTime; <span class="comment">// end time</span>
<a name="l00943"></a>00943   
<a name="l00944"></a>00944       <span class="comment">// gather timing</span>
<a name="l00945"></a>00945       cudaEventElapsedTime(&amp;runTime, dslashStart, gatherStart[2*i+dir]);
<a name="l00946"></a>00946       gatherTime[2*i+dir][0] += runTime; <span class="comment">// start time</span>
<a name="l00947"></a>00947       cudaEventElapsedTime(&amp;runTime, dslashStart, gatherEnd[2*i+dir]);
<a name="l00948"></a>00948       gatherTime[2*i+dir][1] += runTime; <span class="comment">// end time</span>
<a name="l00949"></a>00949       
<a name="l00950"></a>00950       <span class="comment">// comms timing</span>
<a name="l00951"></a>00951       runTime = <a class="code" href="interface__quda_8cpp.html#a9c0eeff8b945b58c9fa03ce9adf2f6d1">TDIFF</a>(dslashStart_h, commsStart[2*i+dir]);
<a name="l00952"></a>00952       commsTime[2*i+dir][0] += runTime; <span class="comment">// start time</span>
<a name="l00953"></a>00953       runTime = <a class="code" href="interface__quda_8cpp.html#a9c0eeff8b945b58c9fa03ce9adf2f6d1">TDIFF</a>(dslashStart_h, commsEnd[2*i+dir]);
<a name="l00954"></a>00954       commsTime[2*i+dir][1] += runTime; <span class="comment">// end time</span>
<a name="l00955"></a>00955 
<a name="l00956"></a>00956       <span class="comment">// scatter timing</span>
<a name="l00957"></a>00957       cudaEventElapsedTime(&amp;runTime, dslashStart, scatterStart[2*i+dir]);
<a name="l00958"></a>00958       scatterTime[2*i+dir][0] += runTime; <span class="comment">// start time</span>
<a name="l00959"></a>00959       cudaEventElapsedTime(&amp;runTime, dslashStart, scatterEnd[2*i+dir]);
<a name="l00960"></a>00960       scatterTime[2*i+dir][1] += runTime; <span class="comment">// end time</span>
<a name="l00961"></a>00961     }
<a name="l00962"></a>00962   }
<a name="l00963"></a>00963 <span class="preprocessor">#endif</span>
<a name="l00964"></a>00964 <span class="preprocessor"></span>
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="keywordtype">void</span> printDslashProfile() {
<a name="l00968"></a>00968   
<a name="l00969"></a>00969   <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;Total Dslash time = %6.2f\n&quot;</span>, dslashTime);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971   <span class="keywordtype">char</span> dimstr[8][8] = {<span class="stringliteral">&quot;X-&quot;</span>, <span class="stringliteral">&quot;X+&quot;</span>, <span class="stringliteral">&quot;Y-&quot;</span>, <span class="stringliteral">&quot;Y+&quot;</span>, <span class="stringliteral">&quot;Z-&quot;</span>, <span class="stringliteral">&quot;Z+&quot;</span>, <span class="stringliteral">&quot;T-&quot;</span>, <span class="stringliteral">&quot;T+&quot;</span>};
<a name="l00972"></a>00972 
<a name="l00973"></a>00973   <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;     %13s %13s %13s %13s %13s\n&quot;</span>, <span class="stringliteral">&quot;Pack&quot;</span>, <span class="stringliteral">&quot;Gather&quot;</span>, <span class="stringliteral">&quot;Comms&quot;</span>, <span class="stringliteral">&quot;Scatter&quot;</span>, <span class="stringliteral">&quot;Kernel&quot;</span>);
<a name="l00974"></a>00974   <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;         %6s %6s %6s %6s %6s %6s %6s %6s %6s %6s\n&quot;</span>, 
<a name="l00975"></a>00975              <span class="stringliteral">&quot;Start&quot;</span>, <span class="stringliteral">&quot;End&quot;</span>, <span class="stringliteral">&quot;Start&quot;</span>, <span class="stringliteral">&quot;End&quot;</span>, <span class="stringliteral">&quot;Start&quot;</span>, <span class="stringliteral">&quot;End&quot;</span>, <span class="stringliteral">&quot;Start&quot;</span>, <span class="stringliteral">&quot;End&quot;</span>, <span class="stringliteral">&quot;Start&quot;</span>, <span class="stringliteral">&quot;End&quot;</span>);
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%8s %55s %6.2f %6.2f\n&quot;</span>, <span class="stringliteral">&quot;Interior&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, kernelTime[8][0], kernelTime[8][1]);
<a name="l00978"></a>00978       
<a name="l00979"></a>00979   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=3; i&gt;=0; i--) {
<a name="l00980"></a>00980     <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) <span class="keywordflow">continue</span>;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; 2; dir ++) {
<a name="l00983"></a>00983       <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%8s &quot;</span>, dimstr[2*i+dir]);
<a name="l00984"></a>00984 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l00985"></a>00985 <span class="preprocessor"></span>      <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%6.2f %6.2f &quot;</span>, packTime[2*i+dir][0], packTime[2*i+dir][1]);
<a name="l00986"></a>00986       <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%6.2f %6.2f &quot;</span>, gatherTime[2*i+dir][0], gatherTime[2*i+dir][1]);
<a name="l00987"></a>00987       <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%6.2f %6.2f &quot;</span>, commsTime[2*i+dir][0], commsTime[2*i+dir][1]);
<a name="l00988"></a>00988       <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%6.2f %6.2f &quot;</span>, scatterTime[2*i+dir][0], scatterTime[2*i+dir][1]);
<a name="l00989"></a>00989 <span class="preprocessor">#endif</span>
<a name="l00990"></a>00990 <span class="preprocessor"></span>
<a name="l00991"></a>00991       <span class="keywordflow">if</span> (dir==0) <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;%6.2f %6.2f\n&quot;</span>, kernelTime[2*i][0], kernelTime[2*i][1]);
<a name="l00992"></a>00992       <span class="keywordflow">else</span> <a class="code" href="util__quda_8h.html#a35882d3606e4edaa96d082d239d0e7a0">printfQuda</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994   }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 }
<a name="l00997"></a>00997 <span class="preprocessor">#endif</span>
<a name="l00998"></a>00998 <span class="preprocessor"></span>
<a name="l00999"></a><a class="code" href="dslash__quda_8cu.html#ab47eadeea30cb7951ec9ef0c4b1d95ee">00999</a> <span class="keywordtype">int</span> <a class="code" href="dslash__quda_8cu.html#ab47eadeea30cb7951ec9ef0c4b1d95ee">gatherCompleted</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l01000"></a><a class="code" href="dslash__quda_8cu.html#a52598369f0300ef69875b4e72d5b8120">01000</a> <span class="keywordtype">int</span> <a class="code" href="dslash__quda_8cu.html#a52598369f0300ef69875b4e72d5b8120">previousDir</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l01001"></a><a class="code" href="dslash__quda_8cu.html#a4b4973bd12de6f4e7ff23d8c991b1f40">01001</a> <span class="keywordtype">int</span> <a class="code" href="dslash__quda_8cu.html#a4b4973bd12de6f4e7ff23d8c991b1f40">commsCompleted</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>];
<a name="l01002"></a><a class="code" href="dslash__quda_8cu.html#aa1edc6d7ca84aeac83cc7deb2ff1818b">01002</a> <span class="keywordtype">int</span> <a class="code" href="dslash__quda_8cu.html#aa1edc6d7ca84aeac83cc7deb2ff1818b">commDimTotal</a>;
<a name="l01003"></a>01003 
<a name="l01007"></a><a class="code" href="dslash__quda_8cu.html#a8f27e12a77a9cc2fa7327dbb40c18ad6">01007</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8cu.html#a8f27e12a77a9cc2fa7327dbb40c18ad6">initDslashCommsPattern</a>() {
<a name="l01008"></a>01008   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1; i++) {
<a name="l01009"></a>01009     gatherCompleted[i] = 0;
<a name="l01010"></a>01010     commsCompleted[i] = 0;
<a name="l01011"></a>01011   }
<a name="l01012"></a>01012   gatherCompleted[Nstream-1] = 1;
<a name="l01013"></a>01013   commsCompleted[Nstream-1] = 1;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015   <span class="comment">//   We need to know which was the previous direction in which</span>
<a name="l01016"></a>01016   <span class="comment">//   communication was issued, since we only query a given event /</span>
<a name="l01017"></a>01017   <span class="comment">//   comms call after the previous the one has successfully</span>
<a name="l01018"></a>01018   <span class="comment">//   completed.</span>
<a name="l01019"></a>01019   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=3; i&gt;=0; i--) {
<a name="l01020"></a>01020     <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) {
<a name="l01021"></a>01021       <span class="keywordtype">int</span> prev = Nstream-1;
<a name="l01022"></a>01022       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=3; j&gt;i; j--) <span class="keywordflow">if</span> (dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[j]) prev = 2*j;
<a name="l01023"></a>01023       previousDir[2*i + 1] = prev;
<a name="l01024"></a>01024       previousDir[2*i + 0] = 2*i + 1; <span class="comment">// always valid</span>
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026   }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028   <span class="comment">// this tells us how many events / comms occurances there are in</span>
<a name="l01029"></a>01029   <span class="comment">// total.  Used for exiting the while loop</span>
<a name="l01030"></a>01030   commDimTotal = 0;
<a name="l01031"></a>01031   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=3; i&gt;=0; i--) commDimTotal += dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i];
<a name="l01032"></a>01032   commDimTotal *= 4; <span class="comment">// 2 from pipe length, 2 from direction</span>
<a name="l01033"></a>01033 }
<a name="l01034"></a>01034 
<a name="l01035"></a><a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">01035</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">dslashCuda</a>(<a class="code" href="class_dslash_cuda.html">DslashCuda</a> &amp;<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> regSize, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, 
<a name="l01036"></a>01036                 <span class="keyword">const</span> <span class="keywordtype">int</span> volume, <span class="keyword">const</span> <span class="keywordtype">int</span> *faceVolumeCB) {
<a name="l01037"></a>01037 
<a name="l01038"></a>01038   dslashParam.<a class="code" href="struct_dslash_param.html#a43877ae1ec8a85d45a2b74a2bad9c291">parity</a> = <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>;
<a name="l01039"></a>01039   dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> = <a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9a2519f4625499fa136deb23c5960bada0">INTERIOR_KERNEL</a>;
<a name="l01040"></a>01040   dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a> = volume;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042   <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(dslashStart, 0);
<a name="l01043"></a>01043   gettimeofday(&amp;dslashStart_h, NULL);
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l01046"></a>01046 <span class="preprocessor"></span>  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 3; i &gt;=0; i--){
<a name="l01047"></a>01047     <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) <span class="keywordflow">continue</span>;
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     <span class="comment">// Record the start of the packing</span>
<a name="l01050"></a>01050     <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(packStart[2*i+0], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01051"></a>01051     <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(packStart[2*i+1], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="comment">// Initialize pack from source spinor</span>
<a name="l01054"></a>01054     face-&gt;<a class="code" href="class_face_buffer.html#ad8f4f38c57765f852e4f486dbd354362">pack</a>(*inSpinor, 1-parity, dagger, i, <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>);
<a name="l01055"></a>01055     
<a name="l01056"></a>01056     <span class="comment">// Record the end of the packing</span>
<a name="l01057"></a>01057     cudaEventRecord(packEnd[2*i+0], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01058"></a>01058     cudaEventRecord(packEnd[2*i+1], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01059"></a>01059   }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 3; i &gt;=0; i--){
<a name="l01062"></a>01062     <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) <span class="keywordflow">continue</span>;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir=1; dir&gt;=0; dir--) {
<a name="l01065"></a>01065       cudaStreamWaitEvent(<a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[2*i+dir], packEnd[2*i+dir], 0);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067       <span class="comment">// Record the start of the gathering</span>
<a name="l01068"></a>01068       <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(gatherStart[2*i+dir], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[2*i+dir]);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070       <span class="comment">// Initialize host transfer from source spinor</span>
<a name="l01071"></a>01071       face-&gt;<a class="code" href="class_face_buffer.html#aa36ea4946f9cf4f150bab6e8b19e4797">gather</a>(*inSpinor, dagger, 2*i+dir);
<a name="l01072"></a>01072 
<a name="l01073"></a>01073       <span class="comment">// Record the end of the gathering</span>
<a name="l01074"></a>01074       cudaEventRecord(gatherEnd[2*i+dir], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[2*i+dir]);
<a name="l01075"></a>01075     }
<a name="l01076"></a>01076   }
<a name="l01077"></a>01077 <span class="preprocessor">#endif</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span>
<a name="l01079"></a>01079   <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(kernelStart[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01080"></a>01080   dslash.<a class="code" href="class_tunable.html#ad33ab9bec510fdb3bcb90561735a08ed">apply</a>(<a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01081"></a>01081   <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(kernelEnd[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span>  <a class="code" href="dslash__quda_8cu.html#a8f27e12a77a9cc2fa7327dbb40c18ad6">initDslashCommsPattern</a>();
<a name="l01085"></a>01085 
<a name="l01086"></a>01086   <span class="keywordtype">int</span> completeSum = 0;
<a name="l01087"></a>01087   <span class="keywordflow">while</span> (completeSum &lt; commDimTotal) {
<a name="l01088"></a>01088     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=3; i&gt;=0; i--) {
<a name="l01089"></a>01089       <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) <span class="keywordflow">continue</span>;
<a name="l01090"></a>01090       
<a name="l01091"></a>01091       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir=1; dir&gt;=0; dir--) {
<a name="l01092"></a>01092         
<a name="l01093"></a>01093         <span class="comment">// Query if gather has completed</span>
<a name="l01094"></a>01094         <span class="keywordflow">if</span> (!gatherCompleted[2*i+dir] &amp;&amp; gatherCompleted[previousDir[2*i+dir]]) { 
<a name="l01095"></a>01095           <span class="keywordflow">if</span> (cudaSuccess == cudaEventQuery(gatherEnd[2*i+dir])) {
<a name="l01096"></a>01096             gatherCompleted[2*i+dir] = 1;
<a name="l01097"></a>01097             completeSum++;
<a name="l01098"></a>01098             gettimeofday(&amp;commsStart[2*i+dir], NULL);
<a name="l01099"></a>01099             face-&gt;<a class="code" href="class_face_buffer.html#a048326a263d4e5436275066f9c2a1931">commsStart</a>(2*i+dir);
<a name="l01100"></a>01100           }
<a name="l01101"></a>01101         }
<a name="l01102"></a>01102         
<a name="l01103"></a>01103         <span class="comment">// Query if comms has finished</span>
<a name="l01104"></a>01104         <span class="keywordflow">if</span> (!commsCompleted[2*i+dir] &amp;&amp; commsCompleted[previousDir[2*i+dir]] &amp;&amp;
<a name="l01105"></a>01105             gatherCompleted[2*i+dir]) {
<a name="l01106"></a>01106           <span class="keywordflow">if</span> (face-&gt;<a class="code" href="class_face_buffer.html#aa1a19b1c3a161d0f17d686dd1b86e9c7">commsQuery</a>(2*i+dir)) { 
<a name="l01107"></a>01107             commsCompleted[2*i+dir] = 1;
<a name="l01108"></a>01108             completeSum++;
<a name="l01109"></a>01109             gettimeofday(&amp;commsEnd[2*i+dir], NULL);
<a name="l01110"></a>01110             
<a name="l01111"></a>01111             <span class="comment">// Record the end of the scattering</span>
<a name="l01112"></a>01112             <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(scatterStart[2*i+dir], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[2*i+dir]);
<a name="l01113"></a>01113             
<a name="l01114"></a>01114             <span class="comment">// Scatter into the end zone</span>
<a name="l01115"></a>01115             face-&gt;<a class="code" href="class_face_buffer.html#abcb4b56b57660cc9c5d8c8035c352a57">scatter</a>(*inSpinor, dagger, 2*i+dir);
<a name="l01116"></a>01116             
<a name="l01117"></a>01117             <span class="comment">// Record the end of the scattering</span>
<a name="l01118"></a>01118             cudaEventRecord(scatterEnd[2*i+dir], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[2*i+dir]);
<a name="l01119"></a>01119           }
<a name="l01120"></a>01120         }
<a name="l01121"></a>01121 
<a name="l01122"></a>01122       }
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124     
<a name="l01125"></a>01125   }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=3; i&gt;=0; i--) {
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (!dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i]) <span class="keywordflow">continue</span>;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130     dslashParam.<a class="code" href="struct_dslash_param.html#a82719bc0f2917ddf4bd4683219d510f3">kernel_type</a> = <span class="keyword">static_cast&lt;</span><a class="code" href="dslash__quda_8cu.html#a20fb43c4dec0741b9e11a076701f19e9">KernelType</a><span class="keyword">&gt;</span>(i);
<a name="l01131"></a>01131     dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a> = dslash.<a class="code" href="class_dslash_cuda.html#a7b05c0482263bda3ee6aa303982addcc">Nface</a>()*faceVolumeCB[i]; <span class="comment">// updating 2 or 6 faces</span>
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     <span class="comment">// wait for scattering to finish and then launch dslash</span>
<a name="l01134"></a>01134     cudaStreamWaitEvent(<a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1], scatterEnd[2*i], 0);
<a name="l01135"></a>01135     cudaStreamWaitEvent(<a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1], scatterEnd[2*i+1], 0);
<a name="l01136"></a>01136 
<a name="l01137"></a>01137     <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(kernelStart[2*i], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01138"></a>01138     dslash.<a class="code" href="class_tunable.html#ad33ab9bec510fdb3bcb90561735a08ed">apply</a>(<a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]); <span class="comment">// all faces use this stream</span>
<a name="l01139"></a>01139     <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(kernelEnd[2*i], <a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01140"></a>01140   }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142   <a class="code" href="dslash__quda_8cu.html#a930ed98914a2dbb9b441e9e65fbce9a7">CUDA_EVENT_RECORD</a>(dslashEnd, 0);
<a name="l01143"></a>01143   <a class="code" href="dslash__quda_8cu.html#aca98c17a71baa5a33c4f4bc5d341d596">DSLASH_TIME_PROFILE</a>();
<a name="l01144"></a>01144 
<a name="l01145"></a>01145 <span class="preprocessor">#endif // MULTI_GPU</span>
<a name="l01146"></a>01146 <span class="preprocessor"></span>}
<a name="l01147"></a>01147 
<a name="l01148"></a>01148 <span class="comment">// Wilson wrappers</span>
<a name="l01149"></a><a class="code" href="dslash__quda_8cu.html#af5509e6d478cc62d370baca1fd2e1135">01149</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#ae075dceeb9f4258bdf56a6ed6d34251a">wilsonDslashCuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;<a class="code" href="su3__test_8cpp.html#a39c107c8195f24da0adc6d2677ff563a">gauge</a>, <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>,
<a name="l01150"></a>01150                       <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="blas__quda_8cu.html#ab785f167db51e5445112e14e0b8ef6ae">x</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;k, <span class="keyword">const</span> <span class="keywordtype">int</span> *commOverride)
<a name="l01151"></a>01151 {
<a name="l01152"></a>01152   inSpinor = (<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a>*)in; <span class="comment">// EVIL</span>
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 <span class="preprocessor">#ifdef GPU_WILSON_DIRAC</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>  <span class="keywordtype">int</span> Npad = (in-&gt;<a class="code" href="class_color_spinor_field.html#af193c52cca2b84109c9714f32b4dfae0">Ncolor</a>()*in-&gt;<a class="code" href="class_color_spinor_field.html#abdd88a39f9f275bf5459ba34f4f3f0ae">Nspin</a>()*2)/in-&gt;<a class="code" href="class_color_spinor_field.html#a668109b89e47131d1b05fb3076705e5e">FieldOrder</a>(); <span class="comment">// SPINOR_HOP in old code</span>
<a name="l01156"></a>01156   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;4;i++){
<a name="l01157"></a>01157     dslashParam.<a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">ghostDim</a>[i] = <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// determines whether to use regular or ghost indexing at boundary</span>
<a name="l01158"></a>01158     dslashParam.<a class="code" href="struct_dslash_param.html#a71a096e0b08481398ba30def5c0c6c6b">ghostOffset</a>[i] = Npad*(in-&gt;<a class="code" href="class_color_spinor_field.html#a6e6b512c3908696a701f17b88de59b64">GhostOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>());
<a name="l01159"></a>01159     dslashParam.<a class="code" href="struct_dslash_param.html#ac8762c9f3aa29fd85632efc13a3aff6f">ghostNormOffset</a>[i] = in-&gt;<a class="code" href="class_color_spinor_field.html#a83503de4f84cf8aab4ec19a06d3a74b1">GhostNormOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>();
<a name="l01160"></a>01160     dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i] = (!commOverride[i]) ? 0 : <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// switch off comms if override = 0</span>
<a name="l01161"></a>01161   }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163   <span class="keywordtype">void</span> *gauge0, *gauge1;
<a name="l01164"></a>01164   <a class="code" href="dslash__textures_8h.html#a0d419f2533ec5be1f621dda4ff51e244">bindGaugeTex</a>(gauge, parity, &amp;gauge0, &amp;gauge1);
<a name="l01165"></a>01165 
<a name="l01166"></a>01166   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != gauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>())
<a name="l01167"></a>01167     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing gauge %d and spinor %d precision not supported&quot;</span>, 
<a name="l01168"></a>01168               gauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>());
<a name="l01169"></a>01169 
<a name="l01170"></a>01170   <span class="keyword">const</span> <span class="keywordtype">void</span> *xv = (x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>() : 0);
<a name="l01171"></a>01171   <span class="keyword">const</span> <span class="keywordtype">void</span> *xn = (x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>() : 0);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173   <a class="code" href="class_dslash_cuda.html">DslashCuda</a> *<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a> = 0;
<a name="l01174"></a>01174   <span class="keywordtype">size_t</span> regSize = <span class="keyword">sizeof</span>(float);
<a name="l01175"></a>01175   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01176"></a>01176 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span>    dslash = <span class="keyword">new</span> <a class="code" href="class_wilson_dslash_cuda.html">WilsonDslashCuda&lt;double2, double2&gt;</a>((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01178"></a>01178                                                     (double2*)gauge0, (double2*)gauge1, 
<a name="l01179"></a>01179                                                     gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01180"></a>01180                                                     (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)xv, (<span class="keywordtype">float</span>*)xn,
<a name="l01181"></a>01181                                                     k, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01182"></a>01182     regSize = <span class="keyword">sizeof</span>(double);
<a name="l01183"></a>01183 <span class="preprocessor">#else</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01185"></a>01185 <span class="preprocessor">#endif</span>
<a name="l01186"></a>01186 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01187"></a>01187     dslash = <span class="keyword">new</span> <a class="code" href="class_wilson_dslash_cuda.html">WilsonDslashCuda&lt;float4, float4&gt;</a>((float4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)gauge0, (float4*)gauge1,
<a name="l01188"></a>01188                                                   gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (float4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01189"></a>01189                                                   (float4*)xv, (<span class="keywordtype">float</span>*)xn, k, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01190"></a>01190   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {
<a name="l01191"></a>01191     dslash = <span class="keyword">new</span> <a class="code" href="class_wilson_dslash_cuda.html">WilsonDslashCuda&lt;short4, short4&gt;</a>((short4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)gauge0, (short4*)gauge1,
<a name="l01192"></a>01192                                                   gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (short4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(),
<a name="l01193"></a>01193                                                   (short4*)xv, (<span class="keywordtype">float</span>*)xn, k, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01194"></a>01194   }
<a name="l01195"></a>01195   <a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">dslashCuda</a>(*dslash, regSize, parity, dagger, in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#aa6735760848d7940ab324d5b78666b98">GhostFace</a>());
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   <span class="keyword">delete</span> <a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>;
<a name="l01198"></a>01198   <a class="code" href="dslash__textures_8h.html#a047ccd3170c83364f2d61f27ea00f622">unbindGaugeTex</a>(gauge);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01201"></a>01201 <span class="preprocessor">#else</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Wilson dslash has not been built&quot;</span>);
<a name="l01203"></a>01203 <span class="preprocessor">#endif // GPU_WILSON_DIRAC</span>
<a name="l01204"></a>01204 <span class="preprocessor"></span>
<a name="l01205"></a>01205 }
<a name="l01206"></a>01206 
<a name="l01207"></a><a class="code" href="dslash__quda_8cu.html#a296651999de54f01fa97cb5d362a1c2f">01207</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#a00094bcaacb8c7e7824da889fdf3cdee">cloverDslashCuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;<a class="code" href="su3__test_8cpp.html#a39c107c8195f24da0adc6d2677ff563a">gauge</a>, <span class="keyword">const</span> <a class="code" href="struct_full_clover.html">FullClover</a> cloverInv,
<a name="l01208"></a>01208                       <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, 
<a name="l01209"></a>01209                       <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="blas__quda_8cu.html#ab785f167db51e5445112e14e0b8ef6ae">x</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;a, <span class="keyword">const</span> <span class="keywordtype">int</span> *commOverride)
<a name="l01210"></a>01210 {
<a name="l01211"></a>01211   inSpinor = (<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a>*)in; <span class="comment">// EVIL</span>
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 <span class="preprocessor">#ifdef GPU_CLOVER_DIRAC</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span>  <span class="keywordtype">int</span> Npad = (in-&gt;<a class="code" href="class_color_spinor_field.html#af193c52cca2b84109c9714f32b4dfae0">Ncolor</a>()*in-&gt;<a class="code" href="class_color_spinor_field.html#abdd88a39f9f275bf5459ba34f4f3f0ae">Nspin</a>()*2)/in-&gt;<a class="code" href="class_color_spinor_field.html#a668109b89e47131d1b05fb3076705e5e">FieldOrder</a>(); <span class="comment">// SPINOR_HOP in old code</span>
<a name="l01215"></a>01215   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;4;i++){
<a name="l01216"></a>01216     dslashParam.<a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">ghostDim</a>[i] = <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// determines whether to use regular or ghost indexing at boundary</span>
<a name="l01217"></a>01217     dslashParam.<a class="code" href="struct_dslash_param.html#a71a096e0b08481398ba30def5c0c6c6b">ghostOffset</a>[i] = Npad*(in-&gt;<a class="code" href="class_color_spinor_field.html#a6e6b512c3908696a701f17b88de59b64">GhostOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>());
<a name="l01218"></a>01218     dslashParam.<a class="code" href="struct_dslash_param.html#ac8762c9f3aa29fd85632efc13a3aff6f">ghostNormOffset</a>[i] = in-&gt;<a class="code" href="class_color_spinor_field.html#a83503de4f84cf8aab4ec19a06d3a74b1">GhostNormOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>();
<a name="l01219"></a>01219     dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i] = (!commOverride[i]) ? 0 : <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// switch off comms if override = 0</span>
<a name="l01220"></a>01220   }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222   <span class="keywordtype">void</span> *cloverP, *cloverNormP;
<a name="l01223"></a>01223   <a class="code" href="enum__quda_8h.html#a9b666ae4e5712c6e65313c6a7a576ecc">QudaPrecision</a> clover_prec = <a class="code" href="dslash__textures_8h.html#a7d9680c22b272ed65615cc3b011d045e">bindCloverTex</a>(cloverInv, parity, &amp;cloverP, &amp;cloverNormP);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225   <span class="keywordtype">void</span> *gauge0, *gauge1;
<a name="l01226"></a>01226   <a class="code" href="dslash__textures_8h.html#a0d419f2533ec5be1f621dda4ff51e244">bindGaugeTex</a>(gauge, parity, &amp;gauge0, &amp;gauge1);
<a name="l01227"></a>01227 
<a name="l01228"></a>01228   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != gauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>())
<a name="l01229"></a>01229     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing gauge and spinor precision not supported&quot;</span>);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != clover_prec)
<a name="l01232"></a>01232     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing clover and spinor precision not supported&quot;</span>);
<a name="l01233"></a>01233 
<a name="l01234"></a>01234   <span class="keyword">const</span> <span class="keywordtype">void</span> *xv = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>() : 0;
<a name="l01235"></a>01235   <span class="keyword">const</span> <span class="keywordtype">void</span> *xn = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>() : 0;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237   <a class="code" href="class_dslash_cuda.html">DslashCuda</a> *<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a> = 0;
<a name="l01238"></a>01238   <span class="keywordtype">size_t</span> regSize = <span class="keyword">sizeof</span>(float);
<a name="l01239"></a>01239 
<a name="l01240"></a>01240   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01241"></a>01241 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01242"></a>01242 <span class="preprocessor"></span>    dslash = <span class="keyword">new</span> <a class="code" href="class_clover_dslash_cuda.html">CloverDslashCuda&lt;double2, double2, double2&gt;</a>((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)gauge0, 
<a name="l01243"></a>01243                                                              (double2*)gauge1, gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (double2*)cloverP, 
<a name="l01244"></a>01244                                                              (<span class="keywordtype">float</span>*)cloverNormP, (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(),
<a name="l01245"></a>01245                                                              (double2*)xv, (<span class="keywordtype">float</span>*)xn, a, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01246"></a>01246     regSize = <span class="keyword">sizeof</span>(double);
<a name="l01247"></a>01247 <span class="preprocessor">#else</span>
<a name="l01248"></a>01248 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01249"></a>01249 <span class="preprocessor">#endif</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01251"></a>01251     dslash = <span class="keyword">new</span> <a class="code" href="class_clover_dslash_cuda.html">CloverDslashCuda&lt;float4, float4, float4&gt;</a>((float4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)gauge0, 
<a name="l01252"></a>01252                                                           (float4*)gauge1, gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (float4*)cloverP, 
<a name="l01253"></a>01253                                                           (<span class="keywordtype">float</span>*)cloverNormP, (float4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01254"></a>01254                                                           (float4*)xv, (<span class="keywordtype">float</span>*)xn, a, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01255"></a>01255   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {
<a name="l01256"></a>01256     dslash = <span class="keyword">new</span> <a class="code" href="class_clover_dslash_cuda.html">CloverDslashCuda&lt;short4, short4, short4&gt;</a>((short4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)gauge0, 
<a name="l01257"></a>01257                                                           (short4*)gauge1, gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (short4*)cloverP, 
<a name="l01258"></a>01258                                                           (<span class="keywordtype">float</span>*)cloverNormP, (short4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01259"></a>01259                                                           (short4*)xv, (<span class="keywordtype">float</span>*)xn, a, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01260"></a>01260   }
<a name="l01261"></a>01261 
<a name="l01262"></a>01262   <a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">dslashCuda</a>(*dslash, regSize, parity, dagger, in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#aa6735760848d7940ab324d5b78666b98">GhostFace</a>());
<a name="l01263"></a>01263 
<a name="l01264"></a>01264   <span class="keyword">delete</span> <a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>;
<a name="l01265"></a>01265   <a class="code" href="dslash__textures_8h.html#a047ccd3170c83364f2d61f27ea00f622">unbindGaugeTex</a>(gauge);
<a name="l01266"></a>01266   <a class="code" href="dslash__textures_8h.html#a6cec2cd1f942aa9277b5d6eadede4fbb">unbindCloverTex</a>(cloverInv);
<a name="l01267"></a>01267 
<a name="l01268"></a>01268   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01269"></a>01269 <span class="preprocessor">#else</span>
<a name="l01270"></a>01270 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Clover dslash has not been built&quot;</span>);
<a name="l01271"></a>01271 <span class="preprocessor">#endif</span>
<a name="l01272"></a>01272 <span class="preprocessor"></span>
<a name="l01273"></a>01273 }
<a name="l01274"></a>01274 
<a name="l01275"></a><a class="code" href="dslash__quda_8cu.html#a445b37805e2bba55ad49536728912d26">01275</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#a7e503e767fee0b709da8bce02e168468">twistedMassDslashCuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;<a class="code" href="su3__test_8cpp.html#a39c107c8195f24da0adc6d2677ff563a">gauge</a>, 
<a name="l01276"></a>01276                            <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, 
<a name="l01277"></a>01277                            <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="blas__quda_8cu.html#ab785f167db51e5445112e14e0b8ef6ae">x</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;<a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;<a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, 
<a name="l01278"></a>01278                            <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;a, <span class="keyword">const</span> <span class="keywordtype">int</span> *commOverride)
<a name="l01279"></a>01279 {
<a name="l01280"></a>01280   inSpinor = (<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a>*)in; <span class="comment">// EVIL</span>
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 <span class="preprocessor">#ifdef GPU_TWISTED_MASS_DIRAC</span>
<a name="l01283"></a>01283 <span class="preprocessor"></span>  <span class="keywordtype">int</span> Npad = (in-&gt;<a class="code" href="class_color_spinor_field.html#af193c52cca2b84109c9714f32b4dfae0">Ncolor</a>()*in-&gt;<a class="code" href="class_color_spinor_field.html#abdd88a39f9f275bf5459ba34f4f3f0ae">Nspin</a>()*2)/in-&gt;<a class="code" href="class_color_spinor_field.html#a668109b89e47131d1b05fb3076705e5e">FieldOrder</a>(); <span class="comment">// SPINOR_HOP in old code</span>
<a name="l01284"></a>01284   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;4;i++){
<a name="l01285"></a>01285     dslashParam.<a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">ghostDim</a>[i] = <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// determines whether to use regular or ghost indexing at boundary</span>
<a name="l01286"></a>01286     dslashParam.<a class="code" href="struct_dslash_param.html#a71a096e0b08481398ba30def5c0c6c6b">ghostOffset</a>[i] = Npad*(in-&gt;<a class="code" href="class_color_spinor_field.html#a6e6b512c3908696a701f17b88de59b64">GhostOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>());
<a name="l01287"></a>01287     dslashParam.<a class="code" href="struct_dslash_param.html#ac8762c9f3aa29fd85632efc13a3aff6f">ghostNormOffset</a>[i] = in-&gt;<a class="code" href="class_color_spinor_field.html#a83503de4f84cf8aab4ec19a06d3a74b1">GhostNormOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>();
<a name="l01288"></a>01288     dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i] = (!commOverride[i]) ? 0 : <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// switch off comms if override = 0</span>
<a name="l01289"></a>01289   }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291   <span class="keywordtype">void</span> *gauge0, *gauge1;
<a name="l01292"></a>01292   <a class="code" href="dslash__textures_8h.html#a0d419f2533ec5be1f621dda4ff51e244">bindGaugeTex</a>(gauge, parity, &amp;gauge0, &amp;gauge1);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != gauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>())
<a name="l01295"></a>01295     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing gauge and spinor precision not supported&quot;</span>);
<a name="l01296"></a>01296 
<a name="l01297"></a>01297   <span class="keyword">const</span> <span class="keywordtype">void</span> *xv = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>() : 0;
<a name="l01298"></a>01298   <span class="keyword">const</span> <span class="keywordtype">void</span> *xn = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>() : 0;
<a name="l01299"></a>01299 
<a name="l01300"></a>01300   <a class="code" href="class_dslash_cuda.html">DslashCuda</a> *<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a> = 0;
<a name="l01301"></a>01301   <span class="keywordtype">size_t</span> regSize = <span class="keyword">sizeof</span>(float);
<a name="l01302"></a>01302 
<a name="l01303"></a>01303   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01304"></a>01304 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01305"></a>01305 <span class="preprocessor"></span>    dslash = <span class="keyword">new</span> <a class="code" href="class_twisted_dslash_cuda.html">TwistedDslashCuda&lt;double2,double2&gt;</a>((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)gauge0, 
<a name="l01306"></a>01306                                                     (double2*)gauge1, gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01307"></a>01307                                                     (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)xv, (<span class="keywordtype">float</span>*)xn, 
<a name="l01308"></a>01308                                                     <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, a, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01309"></a>01309     regSize = <span class="keyword">sizeof</span>(double);
<a name="l01310"></a>01310 <span class="preprocessor">#else</span>
<a name="l01311"></a>01311 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01312"></a>01312 <span class="preprocessor">#endif</span>
<a name="l01313"></a>01313 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01314"></a>01314     dslash = <span class="keyword">new</span> <a class="code" href="class_twisted_dslash_cuda.html">TwistedDslashCuda&lt;float4,float4&gt;</a>((float4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)gauge0, (float4*)gauge1, 
<a name="l01315"></a>01315                                                   gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (float4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01316"></a>01316                                                   (float4*)xv, (<span class="keywordtype">float</span>*)xn, <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, a, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01317"></a>01317   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {
<a name="l01318"></a>01318     dslash = <span class="keyword">new</span> <a class="code" href="class_twisted_dslash_cuda.html">TwistedDslashCuda&lt;short4,short4&gt;</a>((short4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)gauge0, (short4*)gauge1, 
<a name="l01319"></a>01319                                                   gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (short4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01320"></a>01320                                                   (short4*)xv, (<span class="keywordtype">float</span>*)xn, <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, a, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01321"></a>01321     
<a name="l01322"></a>01322   }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   <a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">dslashCuda</a>(*dslash, regSize, parity, dagger, in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#aa6735760848d7940ab324d5b78666b98">GhostFace</a>());
<a name="l01325"></a>01325 
<a name="l01326"></a>01326   <span class="keyword">delete</span> <a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>;
<a name="l01327"></a>01327   <a class="code" href="dslash__textures_8h.html#a047ccd3170c83364f2d61f27ea00f622">unbindGaugeTex</a>(gauge);
<a name="l01328"></a>01328 
<a name="l01329"></a>01329   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01330"></a>01330 <span class="preprocessor">#else</span>
<a name="l01331"></a>01331 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Twisted mass dslash has not been built&quot;</span>);
<a name="l01332"></a>01332 <span class="preprocessor">#endif</span>
<a name="l01333"></a>01333 <span class="preprocessor"></span>
<a name="l01334"></a>01334 }
<a name="l01335"></a>01335 
<a name="l01336"></a><a class="code" href="dslash__quda_8cu.html#abaffbc3e840e9d33073482a5c7199d17">01336</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#aeece14a0820b16a47ce77d818d80db61">domainWallDslashCuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;<a class="code" href="su3__test_8cpp.html#a39c107c8195f24da0adc6d2677ff563a">gauge</a>, 
<a name="l01337"></a>01337                           <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, 
<a name="l01338"></a>01338                           <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="blas__quda_8cu.html#ab785f167db51e5445112e14e0b8ef6ae">x</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;m_f, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;k2)
<a name="l01339"></a>01339 {
<a name="l01340"></a>01340   inSpinor = (<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a>*)in; <span class="comment">// EVIL</span>
<a name="l01341"></a>01341 
<a name="l01342"></a>01342 <span class="preprocessor">#ifdef MULTI_GPU</span>
<a name="l01343"></a>01343 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Multi-GPU domain wall not implemented\n&quot;</span>);
<a name="l01344"></a>01344 <span class="preprocessor">#endif</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span>
<a name="l01346"></a>01346   dslashParam.<a class="code" href="struct_dslash_param.html#a43877ae1ec8a85d45a2b74a2bad9c291">parity</a> = <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>;
<a name="l01347"></a>01347   dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a> = in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>();
<a name="l01348"></a>01348 
<a name="l01349"></a>01349 <span class="preprocessor">#ifdef GPU_DOMAIN_WALL_DIRAC</span>
<a name="l01350"></a>01350 <span class="preprocessor"></span>  <span class="keywordtype">void</span> *gauge0, *gauge1;
<a name="l01351"></a>01351   <a class="code" href="dslash__textures_8h.html#a0d419f2533ec5be1f621dda4ff51e244">bindGaugeTex</a>(gauge, parity, &amp;gauge0, &amp;gauge1);
<a name="l01352"></a>01352 
<a name="l01353"></a>01353   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != gauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>())
<a name="l01354"></a>01354     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing gauge and spinor precision not supported&quot;</span>);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356   <span class="keyword">const</span> <span class="keywordtype">void</span> *xv = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>() : 0;
<a name="l01357"></a>01357   <span class="keyword">const</span> <span class="keywordtype">void</span> *xn = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>() : 0;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359   <a class="code" href="class_dslash_cuda.html">DslashCuda</a> *<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a> = 0;
<a name="l01360"></a>01360   <span class="keywordtype">size_t</span> regSize = <span class="keyword">sizeof</span>(float);
<a name="l01361"></a>01361 
<a name="l01362"></a>01362   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01363"></a>01363 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01364"></a>01364 <span class="preprocessor"></span>    dslash = <span class="keyword">new</span> <a class="code" href="class_domain_wall_dslash_cuda.html">DomainWallDslashCuda&lt;double2,double2&gt;</a>((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)gauge0, (double2*)gauge1, 
<a name="l01365"></a>01365                                                        gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)xv, 
<a name="l01366"></a>01366                                                        (<span class="keywordtype">float</span>*)xn, m_f, k2, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01367"></a>01367     regSize = <span class="keyword">sizeof</span>(double);
<a name="l01368"></a>01368 <span class="preprocessor">#else</span>
<a name="l01369"></a>01369 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01370"></a>01370 <span class="preprocessor">#endif</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01372"></a>01372     dslash = <span class="keyword">new</span> <a class="code" href="class_domain_wall_dslash_cuda.html">DomainWallDslashCuda&lt;float4,float4&gt;</a>((float4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)gauge0, (float4*)gauge1, 
<a name="l01373"></a>01373                                                      gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (float4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)xv, 
<a name="l01374"></a>01374                                                      (<span class="keywordtype">float</span>*)xn, m_f, k2, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01375"></a>01375   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {
<a name="l01376"></a>01376     dslash = <span class="keyword">new</span> <a class="code" href="class_domain_wall_dslash_cuda.html">DomainWallDslashCuda&lt;short4,short4&gt;</a>((short4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)gauge0, (short4*)gauge1, 
<a name="l01377"></a>01377                                                      gauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (short4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)xv, 
<a name="l01378"></a>01378                                                      (<span class="keywordtype">float</span>*)xn, m_f, k2, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01379"></a>01379   }
<a name="l01380"></a>01380 
<a name="l01381"></a>01381   <a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">dslashCuda</a>(*dslash, regSize, parity, dagger, in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#aa6735760848d7940ab324d5b78666b98">GhostFace</a>());
<a name="l01382"></a>01382 
<a name="l01383"></a>01383   <span class="keyword">delete</span> <a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>;
<a name="l01384"></a>01384   <a class="code" href="dslash__textures_8h.html#a047ccd3170c83364f2d61f27ea00f622">unbindGaugeTex</a>(gauge);
<a name="l01385"></a>01385 
<a name="l01386"></a>01386   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01387"></a>01387 <span class="preprocessor">#else</span>
<a name="l01388"></a>01388 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Domain wall dslash has not been built&quot;</span>);
<a name="l01389"></a>01389 <span class="preprocessor">#endif</span>
<a name="l01390"></a>01390 <span class="preprocessor"></span>
<a name="l01391"></a>01391 }
<a name="l01392"></a>01392 
<a name="l01393"></a><a class="code" href="dslash__quda_8cu.html#a03421c18066e0690a89eeb5f659f5a5a">01393</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#a1c848e45e561d4c8d0bf2318ad3f6047">staggeredDslashCuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;fatGauge, 
<a name="l01394"></a>01394                          <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;longGauge, <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>,
<a name="l01395"></a>01395                          <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="blas__quda_8cu.html#ab785f167db51e5445112e14e0b8ef6ae">x</a>,
<a name="l01396"></a>01396                          <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;k, <span class="keyword">const</span> <span class="keywordtype">int</span> *commOverride)
<a name="l01397"></a>01397 {
<a name="l01398"></a>01398   inSpinor = (<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a>*)in; <span class="comment">// EVIL</span>
<a name="l01399"></a>01399 
<a name="l01400"></a>01400 <span class="preprocessor">#ifdef GPU_STAGGERED_DIRAC</span>
<a name="l01401"></a>01401 <span class="preprocessor"></span>  <span class="keywordtype">int</span> Npad = (in-&gt;<a class="code" href="class_color_spinor_field.html#af193c52cca2b84109c9714f32b4dfae0">Ncolor</a>()*in-&gt;<a class="code" href="class_color_spinor_field.html#abdd88a39f9f275bf5459ba34f4f3f0ae">Nspin</a>()*2)/in-&gt;<a class="code" href="class_color_spinor_field.html#a668109b89e47131d1b05fb3076705e5e">FieldOrder</a>(); <span class="comment">// SPINOR_HOP in old code</span>
<a name="l01402"></a>01402 
<a name="l01403"></a>01403   dslashParam.<a class="code" href="struct_dslash_param.html#a43877ae1ec8a85d45a2b74a2bad9c291">parity</a> = <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>;
<a name="l01404"></a>01404   dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a> = in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>();
<a name="l01405"></a>01405   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;4;i++){
<a name="l01406"></a>01406     dslashParam.<a class="code" href="struct_dslash_param.html#a892525db120e3258b75120ea871793bd">ghostDim</a>[i] = <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// determines whether to use regular or ghost indexing at boundary</span>
<a name="l01407"></a>01407     dslashParam.<a class="code" href="struct_dslash_param.html#a71a096e0b08481398ba30def5c0c6c6b">ghostOffset</a>[i] = Npad*(in-&gt;<a class="code" href="class_color_spinor_field.html#a6e6b512c3908696a701f17b88de59b64">GhostOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>());
<a name="l01408"></a>01408     dslashParam.<a class="code" href="struct_dslash_param.html#ac8762c9f3aa29fd85632efc13a3aff6f">ghostNormOffset</a>[i] = in-&gt;<a class="code" href="class_color_spinor_field.html#a83503de4f84cf8aab4ec19a06d3a74b1">GhostNormOffset</a>(i) + in-&gt;<a class="code" href="class_color_spinor_field.html#aa0100678a81f4c208f3138ae19366890">Stride</a>();
<a name="l01409"></a>01409     dslashParam.<a class="code" href="struct_dslash_param.html#afd5a8ad761063186f9e8ee97082160ca">commDim</a>[i] = (!commOverride[i]) ? 0 : <a class="code" href="face__quda_8h.html#ab9723e12c958683c4e591e39aee74415">commDimPartitioned</a>(i); <span class="comment">// switch off comms if override = 0</span>
<a name="l01410"></a>01410   }
<a name="l01411"></a>01411   <span class="keywordtype">void</span> *fatGauge0, *fatGauge1;
<a name="l01412"></a>01412   <span class="keywordtype">void</span>* longGauge0, *longGauge1;
<a name="l01413"></a>01413   <a class="code" href="dslash__textures_8h.html#a5a7f80e5ea5b05e731f1f1985a90146a">bindFatGaugeTex</a>(fatGauge, parity, &amp;fatGauge0, &amp;fatGauge1);
<a name="l01414"></a>01414   <a class="code" href="dslash__textures_8h.html#a148babe9c29d80863ba1f90796a6b492">bindLongGaugeTex</a>(longGauge, parity, &amp;longGauge0, &amp;longGauge1);
<a name="l01415"></a>01415     
<a name="l01416"></a>01416   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != fatGauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>() || in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != longGauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>()){
<a name="l01417"></a>01417     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing gauge and spinor precision not supported&quot;</span>
<a name="l01418"></a>01418               <span class="stringliteral">&quot;(precision=%d, fatlinkGauge.precision=%d, longGauge.precision=%d&quot;</span>,
<a name="l01419"></a>01419               in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>(), fatGauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>(), longGauge.<a class="code" href="class_lattice_field.html#ac58e93723964b38b4e8ff46917fc24ca">Precision</a>());
<a name="l01420"></a>01420   }
<a name="l01421"></a>01421     
<a name="l01422"></a>01422   <span class="keyword">const</span> <span class="keywordtype">void</span> *xv = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>() : 0;
<a name="l01423"></a>01423   <span class="keyword">const</span> <span class="keywordtype">void</span> *xn = x ? x-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>() : 0;
<a name="l01424"></a>01424 
<a name="l01425"></a>01425   <a class="code" href="class_dslash_cuda.html">DslashCuda</a> *<a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a> = 0;
<a name="l01426"></a>01426   <span class="keywordtype">size_t</span> regSize = <span class="keyword">sizeof</span>(float);
<a name="l01427"></a>01427 
<a name="l01428"></a>01428   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01429"></a>01429 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01430"></a>01430 <span class="preprocessor"></span>    dslash = <span class="keyword">new</span> <a class="code" href="class_staggered_dslash_cuda.html">StaggeredDslashCuda&lt;double2, double2, double2&gt;</a>((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01431"></a>01431                                                                 (double2*)fatGauge0, (double2*)fatGauge1,
<a name="l01432"></a>01432                                                                 (double2*)longGauge0, (double2*)longGauge1, 
<a name="l01433"></a>01433                                                                 longGauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01434"></a>01434                                                                 (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)xv, (<span class="keywordtype">float</span>*)xn, 
<a name="l01435"></a>01435                                                                 k, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01436"></a>01436     regSize = <span class="keyword">sizeof</span>(double);
<a name="l01437"></a>01437 <span class="preprocessor">#else</span>
<a name="l01438"></a>01438 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01439"></a>01439 <span class="preprocessor">#endif</span>
<a name="l01440"></a>01440 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01441"></a>01441     dslash = <span class="keyword">new</span> <a class="code" href="class_staggered_dslash_cuda.html">StaggeredDslashCuda&lt;float2, float2, float4&gt;</a>((float2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01442"></a>01442                                                              (float2*)fatGauge0, (float2*)fatGauge1,
<a name="l01443"></a>01443                                                              (float4*)longGauge0, (float4*)longGauge1, 
<a name="l01444"></a>01444                                                              longGauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (float2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(),
<a name="l01445"></a>01445                                                              (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float2*)xv, (<span class="keywordtype">float</span>*)xn, 
<a name="l01446"></a>01446                                                              k, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01447"></a>01447   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {  
<a name="l01448"></a>01448     dslash = <span class="keyword">new</span> <a class="code" href="class_staggered_dslash_cuda.html">StaggeredDslashCuda&lt;short2, short2, short4&gt;</a>((short2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01449"></a>01449                                                              (short2*)fatGauge0, (short2*)fatGauge1,
<a name="l01450"></a>01450                                                              (short4*)longGauge0, (short4*)longGauge1, 
<a name="l01451"></a>01451                                                              longGauge.<a class="code" href="class_gauge_field.html#a588b8d5a419ffc7b19eea9a916cc5bf3">Reconstruct</a>(), (short2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01452"></a>01452                                                              (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short2*)xv, (<span class="keywordtype">float</span>*)xn, 
<a name="l01453"></a>01453                                                              k, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>,  in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01454"></a>01454   }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456   <a class="code" href="dslash__quda_8cu.html#a4a1037c567d111b38bc17054f64b49c3">dslashCuda</a>(*dslash, regSize, parity, dagger, in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#aa6735760848d7940ab324d5b78666b98">GhostFace</a>());
<a name="l01457"></a>01457 
<a name="l01458"></a>01458   <span class="keyword">delete</span> <a class="code" href="domain__wall__dslash__reference_8cpp.html#a2cf1361b45fcf5449ba8b652750a3ea6">dslash</a>;
<a name="l01459"></a>01459   <a class="code" href="dslash__textures_8h.html#a047ccd3170c83364f2d61f27ea00f622">unbindGaugeTex</a>(fatGauge);
<a name="l01460"></a>01460   <a class="code" href="dslash__textures_8h.html#a047ccd3170c83364f2d61f27ea00f622">unbindGaugeTex</a>(longGauge);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01463"></a>01463   
<a name="l01464"></a>01464 <span class="preprocessor">#else</span>
<a name="l01465"></a>01465 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Staggered dslash has not been built&quot;</span>);
<a name="l01466"></a>01466 <span class="preprocessor">#endif  // GPU_STAGGERED_DIRAC</span>
<a name="l01467"></a>01467 <span class="preprocessor"></span>}
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 
<a name="l01470"></a>01470 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat, <span class="keyword">typename</span> cFloat&gt;
<a name="l01471"></a><a class="code" href="class_clover_cuda.html">01471</a> <span class="keyword">class </span><a class="code" href="class_clover_cuda.html">CloverCuda</a> : <span class="keyword">public</span> <a class="code" href="class_tunable.html">Tunable</a> {
<a name="l01472"></a>01472  <span class="keyword">private</span>:
<a name="l01473"></a>01473   <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, norm_bytes;
<a name="l01474"></a>01474   sFloat *out;
<a name="l01475"></a>01475   <span class="keywordtype">float</span> *outNorm;
<a name="l01476"></a>01476   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l01477"></a>01477   <span class="keyword">const</span> cFloat *clover;
<a name="l01478"></a>01478   <span class="keyword">const</span> <span class="keywordtype">float</span> *cloverNorm;
<a name="l01479"></a>01479   <span class="keyword">const</span> sFloat *in;
<a name="l01480"></a>01480   <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482  <span class="keyword">protected</span>:
<a name="l01483"></a><a class="code" href="class_clover_cuda.html#a83920b309c9cd14b3d6ddc6568f6a9aa">01483</a>   <span class="keywordtype">int</span> <a class="code" href="class_clover_cuda.html#a83920b309c9cd14b3d6ddc6568f6a9aa">sharedBytesPerThread</a>()<span class="keyword"> const</span>
<a name="l01484"></a>01484 <span class="keyword">  </span>{
<a name="l01485"></a>01485     <span class="keywordtype">int</span> reg_size = (<span class="keyword">typeid</span>(sFloat)==<span class="keyword">typeid</span>(double2) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01486"></a>01486     <span class="keywordflow">return</span> <a class="code" href="dslash__quda_8cu.html#a389d87f736b443d65d63dcd883e5f70b">CLOVER_SHARED_FLOATS_PER_THREAD</a> * reg_size;
<a name="l01487"></a>01487   }
<a name="l01488"></a><a class="code" href="class_clover_cuda.html#ae7086f45d07414777dd21c036545c2a1">01488</a>   <span class="keywordtype">int</span> <a class="code" href="class_clover_cuda.html#ae7086f45d07414777dd21c036545c2a1">sharedBytesPerBlock</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 0; }
<a name="l01489"></a><a class="code" href="class_clover_cuda.html#a527d652fe094856776373f484680d4e8">01489</a>   <span class="keywordtype">bool</span> <a class="code" href="class_clover_cuda.html#a527d652fe094856776373f484680d4e8">advanceGridDim</a>(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;param)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; } <span class="comment">// Don&#39;t tune the grid dimensions.</span>
<a name="l01490"></a>01490 
<a name="l01491"></a>01491  <span class="keyword">public</span>:
<a name="l01492"></a><a class="code" href="class_clover_cuda.html#af5715a82f501b51fbfef056ddfbb36e0">01492</a>   <a class="code" href="class_clover_cuda.html#af5715a82f501b51fbfef056ddfbb36e0">CloverCuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, <span class="keyword">const</span> cFloat *clover, <span class="keyword">const</span> <span class="keywordtype">float</span> *cloverNorm, <span class="keyword">const</span> sFloat *in,
<a name="l01493"></a>01493              <span class="keyword">const</span> <span class="keywordtype">float</span> *inNorm, <span class="keyword">const</span> <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keyword">const</span> <span class="keywordtype">size_t</span> norm_bytes)
<a name="l01494"></a>01494     : out(out), outNorm(outNorm), clover(clover), cloverNorm(cloverNorm), in(in), inNorm(inNorm),
<a name="l01495"></a>01495       bytes(bytes), norm_bytes(norm_bytes)
<a name="l01496"></a>01496   {
<a name="l01497"></a>01497     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm);
<a name="l01498"></a>01498   }
<a name="l01499"></a><a class="code" href="class_clover_cuda.html#ada43b730517a91d8e136606e6d5a6c57">01499</a>   <span class="keyword">virtual</span> <a class="code" href="class_clover_cuda.html#ada43b730517a91d8e136606e6d5a6c57">~CloverCuda</a>() { <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm); }
<a name="l01500"></a><a class="code" href="class_clover_cuda.html#afabbd28b60a99dde48f0b6271a4a3154">01500</a>   <span class="keywordtype">void</span> <a class="code" href="class_clover_cuda.html#afabbd28b60a99dde48f0b6271a4a3154">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>)
<a name="l01501"></a>01501   {
<a name="l01502"></a>01502     <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l01503"></a>01503     dim3 gridDim( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l01504"></a>01504     cloverKernel&lt;&lt;&lt;gridDim, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream&gt;&gt;&gt;(out, outNorm, clover, cloverNorm, in, inNorm, <a class="code" href="dslash__quda_8cu.html#a1779b4d712901ca4fec765531f2d0b1d">dslashParam</a>);
<a name="l01505"></a>01505   }
<a name="l01506"></a><a class="code" href="class_clover_cuda.html#a2194c545bc4fc3651971ff77e8e0e05b">01506</a>   <span class="keyword">virtual</span> <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_clover_cuda.html#a2194c545bc4fc3651971ff77e8e0e05b">tuneKey</a>()<span class="keyword"> const</span>
<a name="l01507"></a>01507 <span class="keyword">  </span>{
<a name="l01508"></a>01508     std::stringstream vol, <a class="code" href="tm__dslash__dagger__fermi__core_8h.html#a13307a0c81bbf19030ea4732534efbec">aux</a>;
<a name="l01509"></a>01509     vol &lt;&lt; dslashConstants.x[0] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l01510"></a>01510     vol &lt;&lt; dslashConstants.x[1] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l01511"></a>01511     vol &lt;&lt; dslashConstants.x[2] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l01512"></a>01512     vol &lt;&lt; dslashConstants.x[3];
<a name="l01513"></a>01513     <span class="keywordflow">return</span> <a class="code" href="class_tune_key.html">TuneKey</a>(vol.str(), <span class="keyword">typeid</span>(*this).name());
<a name="l01514"></a>01514   }
<a name="l01515"></a>01515 
<a name="l01516"></a>01516   <span class="comment">// Need to save the out field if it aliases the in field</span>
<a name="l01517"></a><a class="code" href="class_clover_cuda.html#a1eadb7074ba44531951f8e0fd1a5d710">01517</a>   <span class="keywordtype">void</span> <a class="code" href="class_clover_cuda.html#a1eadb7074ba44531951f8e0fd1a5d710">preTune</a>() {
<a name="l01518"></a>01518     <span class="keywordflow">if</span> (in == out) {
<a name="l01519"></a>01519       saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l01520"></a>01520       cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l01521"></a>01521       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l01522"></a>01522         saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l01523"></a>01523         cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l01524"></a>01524       }
<a name="l01525"></a>01525     }
<a name="l01526"></a>01526   }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528   <span class="comment">// Restore if the in and out fields alias</span>
<a name="l01529"></a><a class="code" href="class_clover_cuda.html#a29ef26380676e907a9c1790b73ff1c55">01529</a>   <span class="keywordtype">void</span> <a class="code" href="class_clover_cuda.html#a29ef26380676e907a9c1790b73ff1c55">postTune</a>() {
<a name="l01530"></a>01530     <span class="keywordflow">if</span> (in == out) {
<a name="l01531"></a>01531       cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l01532"></a>01532       <span class="keyword">delete</span>[] saveOut;
<a name="l01533"></a>01533       <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l01534"></a>01534         cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l01535"></a>01535         <span class="keyword">delete</span>[] saveOutNorm;
<a name="l01536"></a>01536       }
<a name="l01537"></a>01537     }
<a name="l01538"></a>01538   }
<a name="l01539"></a>01539 
<a name="l01540"></a><a class="code" href="class_clover_cuda.html#a30ecae95b6945b98b9b2267183a87609">01540</a>   std::string <a class="code" href="class_clover_cuda.html#a30ecae95b6945b98b9b2267183a87609">paramString</a>(<span class="keyword">const</span> <a class="code" href="class_tune_param.html">TuneParam</a> &amp;param) <span class="keyword">const</span> <span class="comment">// Don&#39;t bother printing the grid dim.</span>
<a name="l01541"></a>01541   {
<a name="l01542"></a>01542     std::stringstream ps;
<a name="l01543"></a>01543     ps &lt;&lt; <span class="stringliteral">&quot;block=(&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.y &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.z &lt;&lt; <span class="stringliteral">&quot;), &quot;</span>;
<a name="l01544"></a>01544     ps &lt;&lt; <span class="stringliteral">&quot;shared=&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>;
<a name="l01545"></a>01545     <span class="keywordflow">return</span> ps.str();
<a name="l01546"></a>01546   }
<a name="l01547"></a>01547 
<a name="l01548"></a>01548 };
<a name="l01549"></a>01549 
<a name="l01550"></a>01550 
<a name="l01551"></a><a class="code" href="dslash__quda_8cu.html#a9d12526d2f7f67ef0df76b0f01fdf860">01551</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#ad6bebc757ea531aaa0bb1c616d2d0893">cloverCuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_gauge_field.html">cudaGaugeField</a> &amp;<a class="code" href="su3__test_8cpp.html#a39c107c8195f24da0adc6d2677ff563a">gauge</a>, <span class="keyword">const</span> <a class="code" href="struct_full_clover.html">FullClover</a> clover, 
<a name="l01552"></a>01552                 <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>) {
<a name="l01553"></a>01553 
<a name="l01554"></a>01554   dslashParam.<a class="code" href="struct_dslash_param.html#a43877ae1ec8a85d45a2b74a2bad9c291">parity</a> = <a class="code" href="domain__wall__dslash__test_8cpp.html#abccfbd3b5ab2deef65e8edf046061ee4">parity</a>;
<a name="l01555"></a>01555   dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a> = in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>();
<a name="l01556"></a>01556 
<a name="l01557"></a>01557 <span class="preprocessor">#ifdef GPU_CLOVER_DIRAC</span>
<a name="l01558"></a>01558 <span class="preprocessor"></span>  <a class="code" href="class_tunable.html">Tunable</a> *clov = 0;
<a name="l01559"></a>01559   <span class="keywordtype">void</span> *cloverP, *cloverNormP;
<a name="l01560"></a>01560   <a class="code" href="enum__quda_8h.html#a9b666ae4e5712c6e65313c6a7a576ecc">QudaPrecision</a> clover_prec = <a class="code" href="dslash__textures_8h.html#a7d9680c22b272ed65615cc3b011d045e">bindCloverTex</a>(clover, parity, &amp;cloverP, &amp;cloverNormP);
<a name="l01561"></a>01561 
<a name="l01562"></a>01562   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() != clover_prec)
<a name="l01563"></a>01563     <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Mixing clover and spinor precision not supported&quot;</span>);
<a name="l01564"></a>01564 
<a name="l01565"></a>01565   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01566"></a>01566 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01567"></a>01567 <span class="preprocessor"></span>    clov = <span class="keyword">new</span> <a class="code" href="class_clover_cuda.html">CloverCuda&lt;double2, double2&gt;</a>((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)cloverP, 
<a name="l01568"></a>01568                                             (<span class="keywordtype">float</span>*)cloverNormP, (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01569"></a>01569                                             in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01570"></a>01570 <span class="preprocessor">#else</span>
<a name="l01571"></a>01571 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01572"></a>01572 <span class="preprocessor">#endif</span>
<a name="l01573"></a>01573 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01574"></a>01574     clov = <span class="keyword">new</span> <a class="code" href="class_clover_cuda.html">CloverCuda&lt;float4, float4&gt;</a>((float4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)cloverP, 
<a name="l01575"></a>01575                           (<span class="keywordtype">float</span>*)cloverNormP, (float4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(),
<a name="l01576"></a>01576                           in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01577"></a>01577   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {
<a name="l01578"></a>01578     clov = <span class="keyword">new</span> <a class="code" href="class_clover_cuda.html">CloverCuda&lt;short4, short4&gt;</a>((short4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)cloverP, 
<a name="l01579"></a>01579                           (<span class="keywordtype">float</span>*)cloverNormP, (short4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), 
<a name="l01580"></a>01580                           in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01581"></a>01581   }
<a name="l01582"></a>01582   clov-&gt;<a class="code" href="class_tunable.html#ad33ab9bec510fdb3bcb90561735a08ed">apply</a>(0);
<a name="l01583"></a>01583 
<a name="l01584"></a>01584   <a class="code" href="dslash__textures_8h.html#a6cec2cd1f942aa9277b5d6eadede4fbb">unbindCloverTex</a>(clover);
<a name="l01585"></a>01585   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01586"></a>01586 
<a name="l01587"></a>01587   <span class="keyword">delete</span> clov;
<a name="l01588"></a>01588 <span class="preprocessor">#else</span>
<a name="l01589"></a>01589 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Clover dslash has not been built&quot;</span>);
<a name="l01590"></a>01590 <span class="preprocessor">#endif</span>
<a name="l01591"></a>01591 <span class="preprocessor"></span>}
<a name="l01592"></a>01592 
<a name="l01593"></a>01593 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> sFloat&gt;
<a name="l01594"></a><a class="code" href="class_twist_gamma5_cuda.html">01594</a> <span class="keyword">class </span><a class="code" href="class_twist_gamma5_cuda.html">TwistGamma5Cuda</a> : <span class="keyword">public</span> <a class="code" href="class_tunable.html">Tunable</a> {
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 <span class="keyword">private</span>:
<a name="l01597"></a>01597   sFloat *out;
<a name="l01598"></a>01598   <span class="keywordtype">float</span> *outNorm;
<a name="l01599"></a>01599   sFloat *in;
<a name="l01600"></a>01600   <span class="keywordtype">float</span> *inNorm;
<a name="l01601"></a>01601   <span class="keywordtype">double</span> a;
<a name="l01602"></a>01602   <span class="keywordtype">double</span> b;
<a name="l01603"></a>01603   <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>;
<a name="l01604"></a>01604   <span class="keywordtype">size_t</span> norm_bytes;
<a name="l01605"></a>01605 
<a name="l01606"></a>01606   <span class="keywordtype">int</span> sharedBytesPerThread()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 0; }
<a name="l01607"></a>01607   <span class="keywordtype">int</span> sharedBytesPerBlock()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 0; }
<a name="l01608"></a>01608   <span class="keywordtype">bool</span> advanceGridDim(<a class="code" href="class_tune_param.html">TuneParam</a> &amp;param)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; } <span class="comment">// Don&#39;t tune the grid dimensions.</span>
<a name="l01609"></a>01609 
<a name="l01610"></a>01610   <span class="keywordtype">char</span> *saveOut, *saveOutNorm;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612 <span class="keyword">public</span>:
<a name="l01613"></a><a class="code" href="class_twist_gamma5_cuda.html#ad798048e87007cf84e66ca8c32580117">01613</a>   <a class="code" href="class_twist_gamma5_cuda.html#ad798048e87007cf84e66ca8c32580117">TwistGamma5Cuda</a>(sFloat *out, <span class="keywordtype">float</span> *outNorm, sFloat *in, <span class="keywordtype">float</span> *inNorm,
<a name="l01614"></a>01614                   <span class="keywordtype">double</span> <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <span class="keywordtype">double</span> <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, 
<a name="l01615"></a>01615                   <a class="code" href="enum__quda_8h.html#a30b3cbc1972d202433ed6582d86a5391">QudaTwistGamma5Type</a> twist, <span class="keywordtype">size_t</span> <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, <span class="keywordtype">size_t</span> norm_bytes) :
<a name="l01616"></a>01616     out(out), outNorm(outNorm), in(in), inNorm(inNorm), 
<a name="l01617"></a>01617     bytes(bytes), norm_bytes(norm_bytes){
<a name="l01618"></a>01618     <a class="code" href="dslash__textures_8h.html#a22405d575024ef6a058bf6e45eb9b089">bindSpinorTex</a>(bytes, norm_bytes, in, inNorm);
<a name="l01619"></a>01619     <a class="code" href="dslash__quda_8cu.html#ab3c21c78c1c28525ac8c11965f9c1c3f">setTwistParam</a>(a, b, kappa, mu, dagger, twist);
<a name="l01620"></a>01620   }
<a name="l01621"></a><a class="code" href="class_twist_gamma5_cuda.html#ad379d9ec4dca089669e0cd46b7749a83">01621</a>   <span class="keyword">virtual</span> <a class="code" href="class_twist_gamma5_cuda.html#ad379d9ec4dca089669e0cd46b7749a83">~TwistGamma5Cuda</a>() {
<a name="l01622"></a>01622     <a class="code" href="dslash__textures_8h.html#a4f6a079841dadc8bcaa0c845b3cac8ab">unbindSpinorTex</a>(in, inNorm);    
<a name="l01623"></a>01623   }
<a name="l01624"></a>01624 
<a name="l01625"></a><a class="code" href="class_twist_gamma5_cuda.html#ac33b52dbe071a0aafe526d0e2020725a">01625</a>   <a class="code" href="class_tune_key.html">TuneKey</a> <a class="code" href="class_twist_gamma5_cuda.html#ac33b52dbe071a0aafe526d0e2020725a">tuneKey</a>()<span class="keyword"> const </span>{
<a name="l01626"></a>01626     std::stringstream vol, <a class="code" href="tm__dslash__dagger__fermi__core_8h.html#a13307a0c81bbf19030ea4732534efbec">aux</a>;
<a name="l01627"></a>01627     vol &lt;&lt; dslashConstants.x[0] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l01628"></a>01628     vol &lt;&lt; dslashConstants.x[1] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l01629"></a>01629     vol &lt;&lt; dslashConstants.x[2] &lt;&lt; <span class="stringliteral">&quot;x&quot;</span>;
<a name="l01630"></a>01630     vol &lt;&lt; dslashConstants.x[3];    
<a name="l01631"></a>01631     <span class="keywordflow">return</span> <a class="code" href="class_tune_key.html">TuneKey</a>(vol.str(), <span class="keyword">typeid</span>(*this).name(), aux.str());
<a name="l01632"></a>01632   }  
<a name="l01633"></a>01633 
<a name="l01634"></a><a class="code" href="class_twist_gamma5_cuda.html#a3ac31389934645e81dfa148fff05114f">01634</a>   <span class="keywordtype">void</span> <a class="code" href="class_twist_gamma5_cuda.html#a3ac31389934645e81dfa148fff05114f">apply</a>(<span class="keyword">const</span> cudaStream_t &amp;<a class="code" href="face__mpi_8cpp.html#a9f4fd0b5397f65cf8963d5001f0001f3">stream</a>) {
<a name="l01635"></a>01635     <a class="code" href="class_tune_param.html">TuneParam</a> tp = <a class="code" href="tune__quda_8h.html#aa41892b4ef1d7ebd4a833d14115dd88a">tuneLaunch</a>(*<span class="keyword">this</span>, dslashTuning, verbosity);
<a name="l01636"></a>01636     dim3 gridDim( (dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a>+tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x-1) / tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x, 1, 1);
<a name="l01637"></a>01637     <a class="code" href="tm__core_8h.html#a6e94097b55fc52a88d699f42dc319a1b">twistGamma5Kernel</a>&lt;&lt;&lt;gridDim, tp.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>, tp.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>, stream&gt;&gt;&gt; 
<a name="l01638"></a>01638       (out, outNorm, a, b, in, inNorm, <a class="code" href="dslash__quda_8cu.html#a1779b4d712901ca4fec765531f2d0b1d">dslashParam</a>);
<a name="l01639"></a>01639   }
<a name="l01640"></a>01640 
<a name="l01641"></a><a class="code" href="class_twist_gamma5_cuda.html#af9e07d9caa048cf1752a7fed60e12f2e">01641</a>   <span class="keywordtype">void</span> <a class="code" href="class_twist_gamma5_cuda.html#af9e07d9caa048cf1752a7fed60e12f2e">preTune</a>() {
<a name="l01642"></a>01642     saveOut = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>];
<a name="l01643"></a>01643     cudaMemcpy(saveOut, out, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyDeviceToHost);
<a name="l01644"></a>01644     <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l01645"></a>01645       saveOutNorm = <span class="keyword">new</span> <span class="keywordtype">char</span>[norm_bytes];
<a name="l01646"></a>01646       cudaMemcpy(saveOutNorm, outNorm, norm_bytes, cudaMemcpyDeviceToHost);
<a name="l01647"></a>01647     }
<a name="l01648"></a>01648   }
<a name="l01649"></a>01649 
<a name="l01650"></a><a class="code" href="class_twist_gamma5_cuda.html#a739e74c94f9209e10faa8b0b28bbcf7a">01650</a>   <span class="keywordtype">void</span> <a class="code" href="class_twist_gamma5_cuda.html#a739e74c94f9209e10faa8b0b28bbcf7a">postTune</a>() {
<a name="l01651"></a>01651     cudaMemcpy(out, saveOut, <a class="code" href="class_tunable.html#a9f76714b84b75b6a4815a6c8c46c5fc3">bytes</a>, cudaMemcpyHostToDevice);
<a name="l01652"></a>01652     <span class="keyword">delete</span>[] saveOut;
<a name="l01653"></a>01653     <span class="keywordflow">if</span> (<span class="keyword">typeid</span>(sFloat) == <span class="keyword">typeid</span>(short4)) {
<a name="l01654"></a>01654       cudaMemcpy(outNorm, saveOutNorm, norm_bytes, cudaMemcpyHostToDevice);
<a name="l01655"></a>01655       <span class="keyword">delete</span>[] saveOutNorm;
<a name="l01656"></a>01656     }
<a name="l01657"></a>01657   }
<a name="l01658"></a>01658 
<a name="l01659"></a><a class="code" href="class_twist_gamma5_cuda.html#a32f61f9f7439460eb9ae54d57399c457">01659</a>   std::string <a class="code" href="class_twist_gamma5_cuda.html#a32f61f9f7439460eb9ae54d57399c457">paramString</a>(<span class="keyword">const</span> <a class="code" href="class_tune_param.html">TuneParam</a> &amp;param)<span class="keyword"> const </span>{
<a name="l01660"></a>01660     std::stringstream ps;
<a name="l01661"></a>01661     ps &lt;&lt; <span class="stringliteral">&quot;block=(&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.x &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.y &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#a6c11885d3e6304bf22e9c9108006fd78">block</a>.z &lt;&lt; <span class="stringliteral">&quot;), &quot;</span>;
<a name="l01662"></a>01662     ps &lt;&lt; <span class="stringliteral">&quot;shared=&quot;</span> &lt;&lt; param.<a class="code" href="class_tune_param.html#abfe0c4e731cdfe25ccaf4370087a4ef5">shared_bytes</a>;
<a name="l01663"></a>01663     <span class="keywordflow">return</span> ps.str();
<a name="l01664"></a>01664   }
<a name="l01665"></a>01665 };
<a name="l01666"></a>01666 
<a name="l01667"></a><a class="code" href="dslash__quda_8cu.html#ac3d45f636d1d7d949e05d9a5849d9f68">01667</a> <span class="keywordtype">void</span> <a class="code" href="dslash__quda_8h.html#a481c44a70a596a025a9e6c8734698fc2">twistGamma5Cuda</a>(<a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af3806a0fd9f2d8dd7a627e9571984d33">out</a>, <span class="keyword">const</span> <a class="code" href="classcuda_color_spinor_field.html">cudaColorSpinorField</a> *<a class="code" href="staggered__invert__test_8cpp.html#af61ff6c9724eb687e3057b6a1a977487">in</a>,
<a name="l01668"></a>01668                      <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;<a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;<a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>,
<a name="l01669"></a>01669                      <span class="keyword">const</span> <a class="code" href="enum__quda_8h.html#a30b3cbc1972d202433ed6582d86a5391">QudaTwistGamma5Type</a> twist)
<a name="l01670"></a>01670 {
<a name="l01671"></a>01671   dslashParam.<a class="code" href="struct_dslash_param.html#acb8b2e10b35fff41050523d9991c229f">threads</a> = in-&gt;<a class="code" href="class_color_spinor_field.html#a2162dfa6150d29e7a1e5d61b4f85ba9b">Volume</a>();
<a name="l01672"></a>01672 
<a name="l01673"></a>01673 <span class="preprocessor">#ifdef GPU_TWISTED_MASS_DIRAC</span>
<a name="l01674"></a>01674 <span class="preprocessor"></span>  <a class="code" href="class_tunable.html">Tunable</a> *<a class="code" href="wilson__dslash__reference_8cpp.html#a363e7e91bdcbd04c132d66ee29ccfe77">twistGamma5</a> = 0;
<a name="l01675"></a>01675 
<a name="l01676"></a>01676   <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a6288ca4c9d3166592676284c7d886972">QUDA_DOUBLE_PRECISION</a>) {
<a name="l01677"></a>01677 <span class="preprocessor">#if (__COMPUTE_CAPABILITY__ &gt;= 130)</span>
<a name="l01678"></a>01678 <span class="preprocessor"></span>    twistGamma5 = <span class="keyword">new</span> <a class="code" href="class_twist_gamma5_cuda.html">TwistGamma5Cuda&lt;double2&gt;</a>
<a name="l01679"></a>01679       ((double2*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (double2*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01680"></a>01680        (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, twist, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01681"></a>01681 <span class="preprocessor">#else</span>
<a name="l01682"></a>01682 <span class="preprocessor"></span>    <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Double precision not supported on this GPU&quot;</span>);
<a name="l01683"></a>01683 <span class="preprocessor">#endif</span>
<a name="l01684"></a>01684 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90a8edc95cbc07156d848030900d84a09e0">QUDA_SINGLE_PRECISION</a>) {
<a name="l01685"></a>01685     twistGamma5 = <span class="keyword">new</span> <a class="code" href="class_twist_gamma5_cuda.html">TwistGamma5Cuda&lt;float4&gt;</a>
<a name="l01686"></a>01686       ((float4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (float4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01687"></a>01687        (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, twist, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01688"></a>01688   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in-&gt;<a class="code" href="class_color_spinor_field.html#a2bbecf6511b79c04c24431e28d45acfc">Precision</a>() == <a class="code" href="enum__quda_8h.html#ac166c47d6ef16f830c164fefe6c8ab90afb568427ae928d5a1330ee47ef03c0b6">QUDA_HALF_PRECISION</a>) {
<a name="l01689"></a>01689     twistGamma5 = <span class="keyword">new</span> <a class="code" href="class_twist_gamma5_cuda.html">TwistGamma5Cuda&lt;short4&gt;</a>
<a name="l01690"></a>01690       ((short4*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), (<span class="keywordtype">float</span>*)out-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), (short4*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#aa4337476b6db7ef770197a63dbe48023">V</a>(), 
<a name="l01691"></a>01691        (<span class="keywordtype">float</span>*)in-&gt;<a class="code" href="classcuda_color_spinor_field.html#a4a99f053432850fcccf73d5923d049c0">Norm</a>(), <a class="code" href="pack__test_8cpp.html#a0f68e4554728ce10ef96d184c2a6a5e1">kappa</a>, <a class="code" href="hisq__paths__force__core_8h.html#abc0b5a6d459dfea2fdbf051483d50f74">mu</a>, <a class="code" href="domain__wall__dslash__test_8cpp.html#a744e506715d5798e73f5e5bc342e0d6d">dagger</a>, twist, in-&gt;<a class="code" href="class_color_spinor_field.html#a3865236a406c549b8eb5fef0eb8fc9ff">Bytes</a>(), in-&gt;<a class="code" href="class_color_spinor_field.html#a0506685f0dbf08a11a07c8e6a9678552">NormBytes</a>());
<a name="l01692"></a>01692   }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694   twistGamma5-&gt;<a class="code" href="class_tunable.html#ad33ab9bec510fdb3bcb90561735a08ed">apply</a>(<a class="code" href="quda__internal_8h.html#a0bf27533c025df9eb1aa7deb98a6fd02">streams</a>[<a class="code" href="quda__internal_8h.html#a61088cc1c59425148ebcc48075ff6b60">Nstream</a>-1]);
<a name="l01695"></a>01695   <a class="code" href="util__quda_8h.html#a7668e6580e0f57b0db3112fae4959e34">checkCudaError</a>();
<a name="l01696"></a>01696 
<a name="l01697"></a>01697   <span class="keyword">delete</span> <a class="code" href="wilson__dslash__reference_8cpp.html#a363e7e91bdcbd04c132d66ee29ccfe77">twistGamma5</a>;
<a name="l01698"></a>01698 <span class="preprocessor">#else</span>
<a name="l01699"></a>01699 <span class="preprocessor"></span>  <a class="code" href="util__quda_8h.html#af3bddfd9d113d50e8e0bbf58a35c5aac">errorQuda</a>(<span class="stringliteral">&quot;Twisted mass dslash has not been built&quot;</span>);
<a name="l01700"></a>01700 <span class="preprocessor">#endif // GPU_TWISTED_MASS_DIRAC</span>
<a name="l01701"></a>01701 <span class="preprocessor"></span>}
<a name="l01702"></a>01702 
<a name="l01703"></a>01703 
<a name="l01704"></a>01704 <span class="preprocessor">#include &quot;<a class="code" href="misc__helpers_8cu.html">misc_helpers.cu</a>&quot;</span>
<a name="l01705"></a>01705 
<a name="l01706"></a>01706 
<a name="l01707"></a>01707 <span class="preprocessor">#if defined(GPU_FATLINK) || defined(GPU_GAUGE_FORCE) || defined(GPU_FERMION_FORCE) || defined(GPU_HISQ_FORCE) || defined(GPU_UNITARIZE)</span>
<a name="l01708"></a>01708 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="force__common_8h.html">force_common.h</a>&gt;</span>
<a name="l01709"></a>01709 <span class="preprocessor">#include &quot;<a class="code" href="force__kernel__common_8cu.html">force_kernel_common.cu</a>&quot;</span>
<a name="l01710"></a>01710 <span class="preprocessor">#endif</span>
<a name="l01711"></a>01711 <span class="preprocessor"></span>
<a name="l01712"></a>01712 <span class="preprocessor">#ifdef GPU_FATLINK</span>
<a name="l01713"></a>01713 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="llfat__quda_8cu.html">llfat_quda.cu</a>&quot;</span>
<a name="l01714"></a>01714 <span class="preprocessor">#endif</span>
<a name="l01715"></a>01715 <span class="preprocessor"></span>
<a name="l01716"></a>01716 <span class="preprocessor">#ifdef GPU_GAUGE_FORCE</span>
<a name="l01717"></a>01717 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="gauge__force__quda_8cu.html">gauge_force_quda.cu</a>&quot;</span>
<a name="l01718"></a>01718 <span class="preprocessor">#endif</span>
<a name="l01719"></a>01719 <span class="preprocessor"></span>
<a name="l01720"></a>01720 <span class="preprocessor">#ifdef GPU_FERMION_FORCE</span>
<a name="l01721"></a>01721 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="fermion__force__quda_8cu.html">fermion_force_quda.cu</a>&quot;</span>
<a name="l01722"></a>01722 <span class="preprocessor">#endif</span>
<a name="l01723"></a>01723 <span class="preprocessor"></span>
<a name="l01724"></a>01724 <span class="preprocessor">#ifdef GPU_UNITARIZE</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="unitarize__links__quda_8cu.html">unitarize_links_quda.cu</a>&quot;</span>
<a name="l01726"></a>01726 <span class="preprocessor">#endif</span>
<a name="l01727"></a>01727 <span class="preprocessor"></span>
<a name="l01728"></a>01728 <span class="preprocessor">#ifdef GPU_HISQ_FORCE</span>
<a name="l01729"></a>01729 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="hisq__paths__force__quda_8cu.html">hisq_paths_force_quda.cu</a>&quot;</span>
<a name="l01730"></a>01730 <span class="preprocessor">#include &quot;<a class="code" href="unitarize__force__quda_8cu.html">unitarize_force_quda.cu</a>&quot;</span>
<a name="l01731"></a>01731 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed Apr 4 2012 21:08:05 for QUDA by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
